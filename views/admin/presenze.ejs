<% var bp = typeof basePath !== 'undefined' ? basePath : ''; %>
<% var mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre']; %>
<h1 class="page-title animate-in">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
  Presenze — <%= mesi[mese - 1] %> <%= anno %>
</h1>

<div class="p-filter">
  <form method="get" action="<%= bp %>/admin/presenze" class="p-filter__inner">
    <div class="p-filter__field">
      <span class="p-filter__label">Mese</span>
      <select name="mese" onchange="this.form.submit()">
        <% for (var m = 1; m <= 12; m++) { %>
        <option value="<%= m %>" <%= m === mese ? 'selected' : '' %>><%= mesi[m - 1] %></option>
        <% } %>
      </select>
    </div>
    <div class="p-filter__field">
      <span class="p-filter__label">Anno</span>
      <select name="anno" onchange="this.form.submit()">
        <% for (var y = new Date().getFullYear() + 1; y >= new Date().getFullYear() - 2; y--) { %>
        <option value="<%= y %>" <%= y === anno ? 'selected' : '' %>><%= y %></option>
        <% } %>
      </select>
    </div>
    <a href="<%= bp %>/admin/presenze/export?anno=<%= anno %>&mese=<%= mese %>" class="btn btn-sm btn--secondary">Esporta CSV</a>
  </form>
</div>

<div class="p-stats">
  <div class="p-stat p-stat--primary">
    <div class="p-stat__value"><%= riepilogo.length %></div>
    <div class="p-stat__label">Dipendenti</div>
  </div>
  <div class="p-stat p-stat--success">
    <div class="p-stat__value"><%= Math.round(riepilogo.reduce(function(s,r){return s + r.ore_totali}, 0) * 10) / 10 %></div>
    <div class="p-stat__label">Ore totali</div>
  </div>
  <div class="p-stat p-stat--warn">
    <div class="p-stat__value"><%= Math.round(riepilogo.reduce(function(s,r){return s + r.ore_straordinario}, 0) * 10) / 10 %></div>
    <div class="p-stat__label">Ore straordinario</div>
  </div>
</div>

<div class="p-card">
  <% if (riepilogo.length === 0) { %>
  <div class="p-empty"><p>Nessun dato per questo mese.</p></div>
  <% } else { %>
  <div class="p-card-body--flush">
    <% riepilogo.forEach(function(r) { %>
    <div class="p-list-item">
      <div class="p-list-item__avatar p-list-item__avatar--primary"><%= r.full_name ? r.full_name.charAt(0).toUpperCase() : '?' %></div>
      <div class="p-list-item__body">
        <div class="p-list-item__title">
          <span class="p-list-item__name"><%= r.full_name || r.username %></span>
          <% if (r.reparto_nome) { %><span class="p-tag p-tag--primary"><%= r.reparto_nome %></span><% } %>
        </div>
        <div class="p-list-item__meta">
          <span>Giorni: <strong><%= r.giorni_presente %></strong></span>
          <span>· Ore: <strong><%= r.ore_totali %></strong></span>
          <% if (r.ore_straordinario > 0) { %><span>· Straordinario: <strong style="color:var(--warning)"><%= r.ore_straordinario %>h</strong></span><% } %>
        </div>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>

<!-- Modale inserimento manuale -->
<div id="manModal" class="modal-overlay admin-ferie-modal" aria-hidden="true" hidden>
  <div class="modal admin-ferie-modal__box admin-ferie-modal__box--form" role="dialog" aria-modal="true" style="max-width:480px">
    <h3 class="modal__title">Inserimento manuale</h3>
    <form id="manForm" class="admin-ferie-edit-form p-modal-form">
      <label>Dipendente
        <select id="manUser" required>
          <option value="">-- Seleziona --</option>
          <% (usersList || []).forEach(function(u) { %>
          <option value="<%= u.id %>"><%= u.full_name || u.username %></option>
          <% }); %>
        </select>
      </label>
      <label>Data <input type="date" id="manData" required></label>
      <div class="p-form-grid-2">
        <label>Entrata <input type="time" id="manEntrata"></label>
        <label>Uscita <input type="time" id="manUscita"></label>
      </div>
      <label>Tipo
        <select id="manTipo">
          <option value="ordinario">Ordinario</option>
          <option value="straordinario">Straordinario</option>
          <option value="trasferta">Trasferta</option>
          <option value="smart_working">Smart Working</option>
        </select>
      </label>
      <label>Note <textarea id="manNote" rows="1"></textarea></label>
      <div class="modal__actions">
        <button type="button" class="btn btn--secondary" onclick="document.getElementById('manModal').setAttribute('hidden','')">Annulla</button>
        <button type="submit" class="btn">Salva</button>
      </div>
    </form>
  </div>
</div>

<script>
var csrf = '<%= csrfToken %>', base = window.APP_BASE || '';
document.getElementById('manForm').onsubmit = async function(e) {
  e.preventDefault();
  try {
    var r = await fetch(base + '/admin/presenze/manuale', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ _csrf: csrf, user_id: document.getElementById('manUser').value, data: document.getElementById('manData').value, ora_entrata: document.getElementById('manEntrata').value, ora_uscita: document.getElementById('manUscita').value, tipo: document.getElementById('manTipo').value, note: document.getElementById('manNote').value })
    });
    var j = await r.json();
    window.showToast(j.message || j.error, j.success ? 'ok' : 'error');
    if (j.success) { document.getElementById('manModal').setAttribute('hidden', ''); location.reload(); }
  } catch (x) { window.showToast('Errore', 'error'); }
};
</script>
