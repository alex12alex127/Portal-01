<% var bp = typeof basePath !== 'undefined' ? basePath : ''; %>
<h1 class="page-title animate-in">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
  Sicurezza sul Lavoro
</h1>

<% if (scadenze.totale > 0) { %>
<div class="p-alert p-alert--danger">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
  <strong class="p-alert__count">Attenzione: <%= scadenze.totale %> scadenze nei prossimi 30 giorni!</strong>
  <span class="p-alert__detail">
    <% if (scadenze.formazioni.length) { %><%= scadenze.formazioni.length %> formazioni<% } %>
    <% if (scadenze.dpi.length) { %> · <%= scadenze.dpi.length %> DPI<% } %>
  </span>
</div>
<% } %>

<!-- Tabs -->
<div class="p-tabs">
  <a href="<%= bp %>/sicurezza?tab=formazioni" class="p-tab<%= tab === 'formazioni' ? ' p-tab--active' : '' %>">Le mie formazioni (<%= formazioni.length %>)</a>
  <a href="<%= bp %>/sicurezza?tab=dpi" class="p-tab<%= tab === 'dpi' ? ' p-tab--active' : '' %>">I miei DPI (<%= dpiConsegne.length %>)</a>
</div>

<!-- ===== TAB FORMAZIONI ===== -->
<% if (tab === 'formazioni') { %>
<div class="p-card" style="border-radius:0 0 var(--radius-lg) var(--radius-lg);border-top:0">
  <% if (formazioni.length === 0) { %>
  <div class="p-empty">
    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5" /></svg>
    <p>Nessuna formazione registrata per te.</p>
  </div>
  <% } else { %>
  <div class="p-card-body--flush">
    <% formazioni.forEach(function(f) { var scaduta = f.data_scadenza && new Date(f.data_scadenza) < new Date(); %>
    <div class="p-list-item<%= scaduta ? ' p-list-item--alert' : '' %>">
      <div class="p-list-item__avatar <%= scaduta ? 'p-list-item__avatar--danger' : 'p-list-item__avatar--primary' %>">
        <svg style="width:20px;height:20px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5" /></svg>
      </div>
      <div class="p-list-item__body">
        <div class="p-list-item__title">
          <span class="p-list-item__name"><%= f.tipo %></span>
          <% if (scaduta) { %><span class="p-tag p-tag--danger">SCADUTA</span><% } %>
          <% if (f.stato === 'rinnovato') { %><span class="p-tag p-tag--success">RINNOVATO</span><% } %>
        </div>
        <div class="p-list-item__meta">
          <% if (f.ente_formatore) { %><span><%= f.ente_formatore %></span><span>·</span><% } %>
          <span>Data: <%= f.data_corso %></span>
          <% if (f.ore) { %><span>· <%= f.ore %> ore</span><% } %>
          <% if (f.data_scadenza) { %><span>· Scadenza: <strong style="color:<%= scaduta ? 'var(--danger)' : 'var(--text)' %>"><%= f.data_scadenza %></strong></span><% } %>
        </div>
        <% if (f.descrizione) { %><div class="p-list-item__sub" style="margin-top:.15rem"><%= f.descrizione %></div><% } %>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>
<% } %>

<!-- ===== TAB DPI ===== -->
<% if (tab === 'dpi') { %>
<div class="p-card" style="border-radius:0 0 var(--radius-lg) var(--radius-lg);border-top:0">
  <% if (dpiConsegne.length === 0) { %>
  <div class="p-empty">
    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
    <p>Nessun DPI registrato per te.</p>
  </div>
  <% } else { %>
  <div class="p-card-body--flush">
    <% dpiConsegne.forEach(function(d) { var scaduto = d.data_scadenza && new Date(d.data_scadenza) < new Date(); %>
    <div class="p-list-item<%= scaduto ? ' p-list-item--alert' : '' %>">
      <div class="p-list-item__avatar <%= scaduto ? 'p-list-item__avatar--danger' : 'p-list-item__avatar--success' %>">
        <svg style="width:20px;height:20px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
      </div>
      <div class="p-list-item__body">
        <div class="p-list-item__title">
          <span class="p-list-item__name"><%= d.tipo_dpi %></span>
          <% if (scaduto) { %><span class="p-tag p-tag--danger">SCADUTO</span><% } %>
          <% if (d.stato === 'sostituito') { %><span class="p-tag p-tag--muted">SOSTITUITO</span><% } %>
        </div>
        <div class="p-list-item__meta">
          <% if (d.taglia) { %><span>Tg. <%= d.taglia %></span><span>·</span><% } %>
          <span>Qtà: <%= d.quantita %></span>
          <span>· Consegnato: <%= d.data_consegna %></span>
          <% if (d.data_scadenza) { %><span>· Scadenza: <strong style="color:<%= scaduto ? 'var(--danger)' : 'var(--text)' %>"><%= d.data_scadenza %></strong></span><% } %>
          <% if (d.lotto) { %><span>· Lotto: <%= d.lotto %></span><% } %>
        </div>
        <% if (d.note) { %><div class="p-list-item__sub" style="margin-top:.15rem"><%= d.note %></div><% } %>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>
<% } %>

