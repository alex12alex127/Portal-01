<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
  Audit Log
</h1>

<div class="card">
  <form method="get" action="<%= typeof basePath !== 'undefined' ? basePath : '' %>/admin/audit" class="ferie-filtri" style="margin-bottom:1rem">
    <label>Utente
      <select name="user_id">
        <option value="">Tutti</option>
        <% (usersList || []).forEach(function(u) { %>
        <option value="<%= u.id %>"<%= filtri.user_id == u.id ? ' selected' : '' %>><%= u.username %></option>
        <% }); %>
      </select>
    </label>
    <label>Azione <input type="text" name="azione" placeholder="es. login, ferie_approvata" value="<%= filtri.azione || '' %>"></label>
    <label>Data <input type="date" name="data" value="<%= filtri.data || '' %>"></label>
    <button type="submit" class="btn btn-sm">Filtra</button>
    <% if (filtri.user_id || filtri.azione || filtri.data) { %>
    <a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/admin/audit" class="btn btn-sm btn--secondary">Reset</a>
    <% } %>
  </form>

  <p class="text-muted" style="margin-bottom:.5rem"><%= pagination.total %> eventi trovati</p>

  <% if (logs.length === 0) { %>
    <p class="empty"><svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg> Nessun evento nel log.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr><th>Data/Ora</th><th>Utente</th><th>Azione</th><th>Dettaglio</th><th>IP</th></tr>
        </thead>
        <tbody>
          <% logs.forEach(function(l) { %>
          <tr>
            <td class="text-muted" style="font-size:.85rem;white-space:nowrap"><%= l.created_at ? new Date(l.created_at).toLocaleString('it-IT') : '' %></td>
            <td><%= l.full_name || l.username || 'â€”' %></td>
            <td><span class="badge badge--avviso badge--info"><%= l.azione %></span></td>
            <td class="text-muted" style="font-size:.85rem;max-width:300px;overflow:hidden;text-overflow:ellipsis"><%= l.dettaglio || '' %></td>
            <td class="text-muted" style="font-size:.85rem"><%= l.ip || '' %></td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <% if (pagination.totalPages > 1) { %>
    <nav class="pagination" style="margin-top:1rem">
      <span class="pagination__info">Pagina <%= pagination.page %> di <%= pagination.totalPages %></span>
      <div class="pagination__links">
        <% if (pagination.page > 1) { %><a href="?page=<%= pagination.page - 1 %>&limit=<%= pagination.limit %>&user_id=<%= filtri.user_id || '' %>&azione=<%= filtri.azione || '' %>&data=<%= filtri.data || '' %>" class="btn btn-sm">Precedente</a><% } %>
        <% if (pagination.page < pagination.totalPages) { %><a href="?page=<%= pagination.page + 1 %>&limit=<%= pagination.limit %>&user_id=<%= filtri.user_id || '' %>&azione=<%= filtri.azione || '' %>&data=<%= filtri.data || '' %>" class="btn btn-sm">Successivo</a><% } %>
      </div>
    </nav>
    <% } %>
  <% } %>
</div>
