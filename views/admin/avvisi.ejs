<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
  Gestione Avvisi
</h1>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem">
    <h2 style="margin:0">Avvisi (<%= avvisi.length %>)</h2>
    <button type="button" class="btn btn-sm" id="btnNewAvviso">+ Nuovo avviso</button>
  </div>

  <% if (avvisi.length === 0) { %>
    <p class="empty"><svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg> Nessun avviso.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr><th>Titolo</th><th>Tipo</th><th>Evidenza</th><th>Visibilità</th><th>Data</th><th>Azioni</th></tr>
        </thead>
        <tbody>
          <% avvisi.forEach(function(a) { %>
          <tr data-id="<%= a.id %>">
            <td>
              <strong><%= a.titolo %></strong>
              <% if (a.contenuto && a.contenuto.length > 60) { %><br><span class="text-muted" style="font-size:.85rem"><%= a.contenuto.substring(0, 60) %>...</span><% } %>
            </td>
            <td><span class="badge badge--avviso badge--<%= a.tipo %>"><%= a.tipo === 'info' ? 'Info' : a.tipo === 'warning' ? 'Attenzione' : a.tipo === 'urgent' ? 'Urgente' : a.tipo === 'success' ? 'Successo' : a.tipo %></span></td>
            <td><%= a.in_evidenza ? 'Sì' : 'No' %></td>
            <td class="text-muted" style="font-size:.85rem">
              <% if (!a.visibile_da && !a.visibile_fino) { %>Sempre
              <% } else { %><%= a.visibile_da ? 'Dal ' + new Date(a.visibile_da).toLocaleDateString('it-IT') : '' %> <%= a.visibile_fino ? 'al ' + new Date(a.visibile_fino).toLocaleDateString('it-IT') : '' %>
              <% } %>
            </td>
            <td class="text-muted" style="font-size:.85rem"><%= a.created_at ? new Date(a.created_at).toLocaleDateString('it-IT') : '' %></td>
            <td>
              <button type="button" class="btn btn-sm btn-edit" data-id="<%= a.id %>">Modifica</button>
              <button type="button" class="btn btn-sm btn--danger btn-del" data-id="<%= a.id %>" data-titolo="<%= a.titolo %>">Elimina</button>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  <% } %>
</div>

<!-- Modale -->
<div id="avvisoModal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border-radius:var(--radius-lg,12px);width:90%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 40px rgba(0,0,0,.15)">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:1.25rem;border-bottom:1px solid var(--border)">
      <h3 id="modalTitle" style="margin:0">Nuovo Avviso</h3>
      <button type="button" id="modalClose" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--muted);padding:0;line-height:1">&times;</button>
    </div>
    <form id="avvisoForm" style="padding:1.25rem">
      <input type="hidden" id="fId" value="">
      <div style="margin-bottom:1rem">
        <label for="fTitolo">Titolo *</label>
        <input type="text" id="fTitolo" name="titolo" required maxlength="255" style="width:100%">
      </div>
      <div style="margin-bottom:1rem">
        <label for="fContenuto">Contenuto *</label>
        <textarea id="fContenuto" name="contenuto" rows="4" required style="width:100%"></textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
        <div>
          <label for="fTipo">Tipo</label>
          <select id="fTipo" name="tipo" style="width:100%">
            <option value="info">Info</option>
            <option value="warning">Attenzione</option>
            <option value="urgent">Urgente</option>
            <option value="success">Successo</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
            <input type="checkbox" id="fEvidenza" name="in_evidenza">
            <span>In evidenza</span>
          </label>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
        <div>
          <label for="fVisibileDa">Visibile dal</label>
          <input type="date" id="fVisibileDa" name="visibile_da" style="width:100%">
        </div>
        <div>
          <label for="fVisibileFino">Visibile fino al</label>
          <input type="date" id="fVisibileFino" name="visibile_fino" style="width:100%">
        </div>
      </div>
      <p class="text-muted" style="font-size:.85rem;margin-bottom:1rem">Se lasci vuoto le date, l'avviso è sempre visibile.</p>
      <div style="display:flex;justify-content:flex-end;gap:.5rem;padding-top:1rem;border-top:1px solid var(--border)">
        <button type="button" class="btn btn-sm" id="modalCancel">Annulla</button>
        <button type="submit" class="btn btn-sm btn--primary" id="modalSave">Salva</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  var base = window.APP_BASE || '';
  var csrf = '<%= csrfToken %>';
  var modal = document.getElementById('avvisoModal');
  var form = document.getElementById('avvisoForm');

  function showMsg(txt, ok) {
    var el = document.createElement('div');
    el.textContent = txt;
    el.style.cssText = 'position:fixed;top:1rem;right:1rem;padding:.75rem 1.25rem;border-radius:var(--radius);color:#fff;font-weight:500;z-index:9999;background:' + (ok ? 'var(--success,#22c55e)' : 'var(--danger,#ef4444)');
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }

  function openModal(title) {
    document.getElementById('modalTitle').textContent = title || 'Nuovo Avviso';
    modal.style.display = 'block';
  }

  function closeModal() {
    modal.style.display = 'none';
    form.reset();
    document.getElementById('fId').value = '';
  }

  // Nuovo avviso
  document.getElementById('btnNewAvviso').addEventListener('click', function() {
    form.reset();
    document.getElementById('fId').value = '';
    openModal('Nuovo Avviso');
  });

  // Chiudi modale
  document.getElementById('modalClose').addEventListener('click', closeModal);
  document.getElementById('modalCancel').addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });

  // Submit form
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    var id = document.getElementById('fId').value;
    var body = {
      titolo: document.getElementById('fTitolo').value,
      contenuto: document.getElementById('fContenuto').value,
      tipo: document.getElementById('fTipo').value,
      in_evidenza: document.getElementById('fEvidenza').checked ? '1' : '',
      visibile_da: document.getElementById('fVisibileDa').value || '',
      visibile_fino: document.getElementById('fVisibileFino').value || ''
    };
    try {
      var url = id ? base + '/admin/avvisi/' + id : base + '/admin/avvisi';
      var method = id ? 'PUT' : 'POST';
      var r = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf }, body: JSON.stringify(body) });
      var data = await r.json();
      if (data.success) {
        showMsg(id ? 'Avviso aggiornato' : 'Avviso creato', true);
        closeModal();
        location.reload();
      } else { showMsg(data.error || 'Errore', false); }
    } catch(err) { showMsg('Errore di rete', false); }
  });

  // Event delegation per modifica e elimina
  document.addEventListener('click', async function(e) {
    // Modifica
    var editBtn = e.target.closest('.btn-edit');
    if (editBtn) {
      var id = editBtn.dataset.id;
      try {
        var r = await fetch(base + '/admin/avvisi/' + id);
        var data = await r.json();
        if (data.success && data.avviso) {
          var a = data.avviso;
          document.getElementById('fId').value = a.id;
          document.getElementById('fTitolo').value = a.titolo;
          document.getElementById('fContenuto').value = a.contenuto;
          document.getElementById('fTipo').value = a.tipo || 'info';
          document.getElementById('fEvidenza').checked = !!a.in_evidenza;
          document.getElementById('fVisibileDa').value = a.visibile_da || '';
          document.getElementById('fVisibileFino').value = a.visibile_fino || '';
          openModal('Modifica Avviso');
        } else { showMsg(data.error || 'Errore caricamento', false); }
      } catch(err) { showMsg('Errore di rete', false); }
    }

    // Elimina
    var delBtn = e.target.closest('.btn-del');
    if (delBtn) {
      var id = delBtn.dataset.id;
      var titolo = delBtn.dataset.titolo;
      if (!confirm('Eliminare "' + titolo + '"?')) return;
      try {
        var r = await fetch(base + '/admin/avvisi/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf } });
        var data = await r.json();
        if (data.success) {
          showMsg('Avviso eliminato', true);
          var row = document.querySelector('tr[data-id="' + id + '"]');
          if (row) row.remove();
        } else { showMsg(data.error || 'Errore', false); }
      } catch(err) { showMsg('Errore di rete', false); }
    }
  });
})();
</script>
