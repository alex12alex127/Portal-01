<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
  Notifiche
</h1>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem">
    <h2 style="margin:0">
      <svg class="icon icon--sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
      Le tue notifiche
      <% if (nonLette > 0) { %><span class="badge badge--alert" style="margin-left:.5rem"><%= nonLette %></span><% } %>
    </h2>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
      <% if (nonLette > 0) { %>
        <button type="button" class="btn btn-sm" id="btnMarkAllRead">Marca tutte come lette (<%= nonLette %>)</button>
      <% } %>
      <% if (notifiche.length > 0) { %>
        <button type="button" class="btn btn-sm btn--danger" id="btnDeleteAll">Elimina tutte</button>
      <% } %>
    </div>
  </div>

  <% if (notifiche.length === 0) { %>
    <p class="empty">
      <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
      Nessuna notifica.
    </p>
  <% } else { %>
    <ul class="notifiche-list" id="notificheList">
      <% notifiche.forEach(function(n) { %>
      <li class="notifiche-item <%= n.letta ? 'letta' : 'non-letta' %>" data-id="<%= n.id %>">
        <div class="notifiche-item__body">
          <strong class="notifiche-item__title"><%= n.titolo || 'Notifica' %></strong>
          <% if (n.messaggio) { %><p class="notifiche-item__msg"><%= n.messaggio %></p><% } %>
          <span class="notifiche-item__date text-muted"><%= n.created_at ? new Date(n.created_at).toLocaleString('it-IT') : '' %></span>
        </div>
        <div class="notifiche-item__actions">
          <% if (!n.letta) { %>
            <button type="button" class="btn btn-sm btn-mark-read" data-id="<%= n.id %>" title="Marca come letta">&#x2713;</button>
          <% } %>
          <button type="button" class="btn btn-sm btn--danger btn-delete" data-id="<%= n.id %>" title="Elimina">&times;</button>
        </div>
      </li>
      <% }); %>
    </ul>
  <% } %>
</div>

<style>
.notifiche-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.5rem }
.notifiche-item { display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; padding:1rem; border:1px solid var(--border); border-radius:var(--radius); transition:opacity .3s }
.notifiche-item.non-letta { border-left:4px solid var(--primary); background:rgba(var(--primary-rgb,59,130,246),.04) }
.notifiche-item.letta { opacity:.7 }
.notifiche-item__body { flex:1; min-width:0 }
.notifiche-item__title { display:block; margin-bottom:.25rem }
.notifiche-item__msg { margin:.25rem 0; font-size:.95rem; color:var(--muted); white-space:pre-wrap; word-break:break-word }
.notifiche-item__date { font-size:.85rem }
.notifiche-item__actions { display:flex; gap:.25rem; flex-shrink:0 }
.notifiche-item.removing { opacity:0; transform:translateX(30px); transition:all .3s }
</style>

<script>
(function(){
  var base = window.APP_BASE || '';

  function showMsg(txt, ok) {
    var el = document.createElement('div');
    el.className = 'toast-msg ' + (ok ? 'toast--ok' : 'toast--err');
    el.textContent = txt;
    el.style.cssText = 'position:fixed;top:1rem;right:1rem;padding:.75rem 1.25rem;border-radius:var(--radius);color:#fff;font-weight:500;z-index:9999;background:' + (ok ? 'var(--success,#22c55e)' : 'var(--danger,#ef4444)');
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }

  async function api(url, method) {
    var r = await fetch(base + url, { method: method || 'POST', headers: { 'Content-Type': 'application/json' } });
    return await r.json();
  }

  document.addEventListener('click', async function(e) {
    // Marca singola come letta
    var markBtn = e.target.closest('.btn-mark-read');
    if (markBtn) {
      var id = markBtn.dataset.id;
      try {
        var res = await api('/notifiche/' + id + '/read', 'POST');
        if (res.success) {
          var item = document.querySelector('.notifiche-item[data-id="' + id + '"]');
          if (item) { item.classList.remove('non-letta'); item.classList.add('letta'); }
          markBtn.remove();
          showMsg('Notifica marcata come letta', true);
          updateBadge(res.nonLette);
        } else { showMsg(res.error || 'Errore', false); }
      } catch(err) { showMsg('Errore di rete', false); }
    }

    // Elimina singola
    var delBtn = e.target.closest('.btn-delete');
    if (delBtn) {
      var id = delBtn.dataset.id;
      if (!confirm('Eliminare questa notifica?')) return;
      try {
        var res = await api('/notifiche/' + id, 'DELETE');
        if (res.success) {
          var item = document.querySelector('.notifiche-item[data-id="' + id + '"]');
          if (item) { item.classList.add('removing'); setTimeout(function(){ item.remove(); checkEmpty(); }, 300); }
          showMsg('Notifica eliminata', true);
          updateBadge(res.nonLette);
        } else { showMsg(res.error || 'Errore', false); }
      } catch(err) { showMsg('Errore di rete', false); }
    }
  });

  // Marca tutte come lette
  var btnAll = document.getElementById('btnMarkAllRead');
  if (btnAll) btnAll.addEventListener('click', async function() {
    try {
      var res = await api('/notifiche/read-all', 'POST');
      if (res.success) {
        document.querySelectorAll('.notifiche-item.non-letta').forEach(function(el) {
          el.classList.remove('non-letta'); el.classList.add('letta');
        });
        document.querySelectorAll('.btn-mark-read').forEach(function(b) { b.remove(); });
        btnAll.style.display = 'none';
        showMsg('Tutte le notifiche marcate come lette (' + (res.updatedCount || 0) + ')', true);
        updateBadge(0);
      } else { showMsg(res.error || 'Errore', false); }
    } catch(err) { showMsg('Errore di rete', false); }
  });

  // Elimina tutte
  var btnDelAll = document.getElementById('btnDeleteAll');
  if (btnDelAll) btnDelAll.addEventListener('click', async function() {
    if (!confirm('Eliminare TUTTE le notifiche?')) return;
    try {
      var res = await api('/notifiche/delete-all', 'DELETE');
      if (res.success) {
        var list = document.getElementById('notificheList');
        if (list) list.innerHTML = '';
        btnDelAll.style.display = 'none';
        if (btnAll) btnAll.style.display = 'none';
        checkEmpty();
        showMsg('Tutte le notifiche eliminate (' + (res.deletedCount || 0) + ')', true);
        updateBadge(0);
      } else { showMsg(res.error || 'Errore', false); }
    } catch(err) { showMsg('Errore di rete', false); }
  });

  function updateBadge(count) {
    var b = document.querySelector('.sidebar .notification-badge');
    if (b) { if (count > 0) { b.textContent = count; b.style.display = ''; } else { b.style.display = 'none'; } }
  }

  function checkEmpty() {
    var list = document.getElementById('notificheList');
    if (list && list.children.length === 0) {
      list.outerHTML = '<p class="empty">Nessuna notifica.</p>';
    }
  }
})();
</script>
