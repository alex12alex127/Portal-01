<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
  Gestione Avvisi
</h1>

<div class="admin-avvisi-actions">
  <button class="btn" onclick="showCreateModal()">
    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> 
    Nuovo Avviso
  </button>
</div>

<div class="card">
  <div class="admin-avvisi-header">
    <h2>Tutti gli avvisi (<%= avvisi.length %>)</h2>
  </div>
  
  <% if (avvisi.length === 0) { %>
    <div class="empty">
      <div class="empty-icon">ðŸ“¢</div>
      <h3>Nessun avviso</h3>
      <p>Crea il primo avviso per comunicare con i dipendenti.</p>
      <button class="btn" onclick="showCreateModal()">Crea Avviso</button>
    </div>
  <% } else { %>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Titolo</th>
            <th>Tipo</th>
            <th>Evidenza</th>
            <th>Autore</th>
            <th>Data</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          <% avvisi.forEach(function(a) { %>
          <tr>
            <td><strong><%= a.titolo %></strong></td>
            <td><span class="badge badge--<%= a.tipo %>"><%= a.tipo %></span></td>
            <td><%= a.in_evidenza ? 'ðŸ“Œ SÃ¬' : 'No' %></td>
            <td><%= a.autore_nome || 'Sistema' %></td>
            <td><%= new Date(a.created_at).toLocaleDateString('it-IT') %></td>
            <td>
              <button class="btn btn-sm" onclick="editAvviso(<%= a.id %>)">Modifica</button>
              <button class="btn btn-sm btn-danger" onclick="deleteAvviso(<%= a.id %>)">Elimina</button>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  <% } %>
</div>

<!-- Modale creazione/modifica avviso -->
<div id="avvisoModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Nuovo Avviso</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    
    <form id="avvisoForm">
      <div class="form-group">
        <label for="titolo">Titolo *</label>
        <input type="text" id="titolo" name="titolo" required maxlength="255">
      </div>
      
      <div class="form-group">
        <label for="contenuto">Contenuto *</label>
        <textarea id="contenuto" name="contenuto" rows="5" required></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="tipo">Tipo</label>
          <select id="tipo" name="tipo">
            <option value="info">Informazione</option>
            <option value="warning">Attenzione</option>
            <option value="urgent">Urgente</option>
            <option value="success">Successo</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="in_evidenza" name="in_evidenza">
            In evidenza
          </label>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Annulla</button>
        <button type="submit" class="btn btn-primary">Salva</button>
      </div>
    </form>
  </div>
</div>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: var(--card-bg);
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
}

.modal form {
  padding: 1.5rem;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-danger:hover {
  background: #dc2626;
}
</style>

<script>
let editingId = null;

function showCreateModal() {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'Nuovo Avviso';
  document.getElementById('avvisoForm').reset();
  document.getElementById('avvisoModal').style.display = 'flex';
}

function editAvviso(id) {
  alert('Funzione modifica in sviluppo');
}

function deleteAvviso(id) {
  if (confirm('Sei sicuro di voler eliminare questo avviso?')) {
    fetch('<%= basePath %>/admin/avvisi/' + id, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '<%= csrfToken %>'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || 'Errore eliminazione');
      }
    })
    .catch(err => {
      console.error('Errore:', err);
      alert('Errore durante l\'eliminazione');
    });
  }
}

function closeModal() {
  document.getElementById('avvisoModal').style.display = 'none';
  document.getElementById('avvisoForm').reset();
  editingId = null;
}

// Gestione submit form
document.getElementById('avvisoForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());
  data._csrf = '<%= csrfToken %>';
  
  fetch('<%= basePath %>/admin/avvisi', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Avviso creato');
      location.reload();
    } else {
      alert(data.error || 'Errore salvataggio');
    }
  })
  .catch(err => {
    console.error('Errore:', err);
    alert('Errore durante il salvataggio');
  });
});

// Chiudi modale cliccando fuori
document.getElementById('avvisoModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeModal();
  }
});
</script>
