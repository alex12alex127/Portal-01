<div class="ferie-page">
  <h1 class="page-title">
    <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>
    Gestione Ferie
  </h1>

  <div class="ferie-layout">
    <div class="ferie-layout__form">
      <div class="card card--ferie-form">
        <h2><svg class="icon icon--sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Nuova richiesta</h2>
        <form id="frm" class="ferie-form">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <div class="ferie-dates">
            <div class="ferie-dates__field">
              <label>Data inizio</label>
              <input type="hidden" id="data_inizio" name="data_inizio" required>
              <button type="button" class="ferie-date-trigger" data-field="data_inizio" aria-label="Scegli data inizio">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5M12 3v1.5m0 15v1.5m9-9h-1.5M3.75 12H5.25m13.5 0a.75.75 0 01-1.5 0H5.25a.75.75 0 010-1.5h13.5a.75.75 0 010 1.5z" /></svg>
                <span class="ferie-date-trigger__text">Seleziona data</span>
              </button>
            </div>
            <div class="ferie-dates__field">
              <label>Data fine</label>
              <input type="hidden" id="data_fine" name="data_fine" required>
              <button type="button" class="ferie-date-trigger" data-field="data_fine" aria-label="Scegli data fine">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5M12 3v1.5m0 15v1.5m9-9h-1.5M3.75 12H5.25m13.5 0a.75.75 0 01-1.5 0H5.25a.75.75 0 010-1.5h13.5a.75.75 0 010 1.5z" /></svg>
                <span class="ferie-date-trigger__text">Seleziona data</span>
              </button>
            </div>
          </div>
          <div id="ferieDatepicker" class="ferie-datepicker" role="dialog" aria-label="Scegli data" aria-modal="true" hidden>
            <div class="ferie-datepicker__header">
              <button type="button" class="ferie-datepicker__prev" aria-label="Mese precedente">‹</button>
              <span class="ferie-datepicker__title"></span>
              <button type="button" class="ferie-datepicker__next" aria-label="Mese successivo">›</button>
            </div>
            <div class="ferie-datepicker__weekdays">
              <span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span><span>Dom</span>
            </div>
            <div class="ferie-datepicker__grid" id="ferieDatepickerGrid"></div>
          </div>
          <div id="ferieDatepickerBackdrop" class="ferie-datepicker__backdrop" aria-hidden="true" hidden></div>
          <div class="ferie-form__row">
            <label for="tipo">Tipo</label>
            <select id="tipo" name="tipo"><option value="ferie">Ferie</option><option value="permesso">Permesso</option><option value="malattia">Malattia</option></select>
          </div>
          <div class="ferie-form__row" id="protocolloRow" style="display:none">
            <label for="codice_protocollo">Codice protocollo medico <span style="color:var(--danger,#dc2626);font-weight:600">*</span></label>
            <input type="text" id="codice_protocollo" name="codice_protocollo" placeholder="Codice rilasciato dal medico di base" maxlength="100">
            <small style="color:var(--muted);font-size:.75rem">Obbligatorio per malattia. Inserisci il codice protocollo INPS del certificato medico.</small>
          </div>
          <div class="ferie-form__row">
            <label for="note">Note <span class="label-optional">(opzionale)</span></label>
            <textarea id="note" name="note" rows="2" placeholder="Eventuali note per il responsabile..."></textarea>
          </div>
          <button type="submit" class="btn btn--full-mobile"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg> <span class="btn-text">Invia richiesta</span></button>
        </form>
        <div id="ferieMsg" role="status" aria-live="polite"></div>
      </div>
    </div>

    <div class="ferie-layout__list">
      <div class="card card--ferie-requests">
        <h2><svg class="icon icon--sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg> Le mie richieste</h2>
        <% if (typeof filtri !== 'undefined') { %>
        <form method="get" action="<%= typeof basePath !== 'undefined' ? basePath : '' %>/ferie" class="ferie-filtri">
          <label>Stato <select name="stato"><option value="">Tutte</option><option value="pending"<%= filtri.stato === 'pending' ? ' selected' : '' %>>In attesa</option><option value="approved"<%= filtri.stato === 'approved' ? ' selected' : '' %>>Approvate</option><option value="rejected"<%= filtri.stato === 'rejected' ? ' selected' : '' %>>Rifiutate</option></select></label>
          <% if (typeof anni !== 'undefined' && anni.length) { %>
          <label>Anno <select name="anno"><option value="">Tutti</option><% anni.forEach(function(y) { %><option value="<%= y %>"<%= filtri.anno === String(y) ? ' selected' : '' %>><%= y %></option><% }); %></select></label>
          <% } %>
          <label>Tipo <select name="tipo"><option value="">Tutti</option><option value="ferie"<%= filtri.tipo === 'ferie' ? ' selected' : '' %>>Ferie</option><option value="permesso"<%= filtri.tipo === 'permesso' ? ' selected' : '' %>>Permesso</option><option value="malattia"<%= filtri.tipo === 'malattia' ? ' selected' : '' %>>Malattia</option></select></label>
          <button type="submit" class="btn btn-sm">Filtra</button>
        </form>
        <% } %>
        <% if (ferie.length === 0) { %>
          <p class="empty"><svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg> Nessuna richiesta. Compila il modulo per inviarne una.</p>
        <% } else { %>
          <div class="ferie-requests-list">
            <% ferie.forEach(function(f) { %>
            <div class="ferie-request-card">
              <div class="ferie-request-card__dates">
                <span class="ferie-request-card__from"><%= f.data_inizio %></span>
                <span class="ferie-request-card__sep">→</span>
                <span class="ferie-request-card__to"><%= f.data_fine %></span>
              </div>
              <div class="ferie-request-card__meta">
                <span class="ferie-request-card__days"><%= f.giorni_totali %> giorni</span>
                <span class="ferie-request-card__tipo"><%= f.tipo %></span>
              </div>
              <% if (f.tipo === 'malattia' && f.codice_protocollo) { %>
              <div style="margin-top:.35rem">
                <span style="display:inline-flex;align-items:center;gap:4px;background:var(--danger,#dc2626);color:#fff;font-size:.75rem;font-weight:700;padding:.3rem .7rem;border-radius:6px;letter-spacing:.02em">
                  <svg style="width:13px;height:13px;flex-shrink:0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                  Protocollo: <%= f.codice_protocollo %>
                </span>
              </div>
              <% } %>
              <span class="badge badge--ferie <%= f.stato %>"><%= f.stato === 'pending' ? 'In attesa' : f.stato === 'approved' ? 'Approvato' : 'Rifiutato' %></span>
              <% if (f.stato === 'pending') { %>
              <div class="ferie-request-card__actions">
                <button type="button" class="btn-sm ferie-edit-btn" data-id="<%= f.id %>" data-inizio="<%= f.data_inizio %>" data-fine="<%= f.data_fine %>" data-tipo="<%= f.tipo %>" data-note="<%= (f.note || '') %>" data-protocollo="<%= (f.codice_protocollo || '') %>">Modifica</button>
                <button type="button" class="btn-sm ferie-withdraw-btn" data-id="<%= f.id %>">Ritira</button>
              </div>
              <% } %>
            </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <div id="ferieEditOverlay" class="modal-overlay admin-ferie-modal" aria-hidden="true" hidden>
    <div class="modal admin-ferie-modal__box admin-ferie-modal__box--form" role="dialog" aria-modal="true">
      <h3 class="modal__title">Modifica richiesta</h3>
      <form id="ferieEditForm" class="admin-ferie-edit-form">
        <input type="hidden" id="ferieEditId" name="id">
        <label>Data inizio <input type="date" id="ferieEditInizio" name="data_inizio" required></label>
        <label>Data fine <input type="date" id="ferieEditFine" name="data_fine" required></label>
        <label>Tipo <select id="ferieEditTipo" name="tipo"><option value="ferie">Ferie</option><option value="permesso">Permesso</option><option value="malattia">Malattia</option></select></label>
        <div id="editProtocolloRow" style="display:none">
          <label>Codice protocollo medico <span style="color:var(--danger,#dc2626);font-weight:600">*</span> <input type="text" id="ferieEditProtocollo" name="codice_protocollo" placeholder="Codice rilasciato dal medico di base" maxlength="100"></label>
        </div>
        <label>Note <textarea id="ferieEditNote" name="note" rows="2"></textarea></label>
        <div class="modal__actions">
          <button type="button" class="btn btn--secondary" id="ferieEditCancel">Annulla</button>
          <button type="submit" class="btn">Salva</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card card--calendar">
    <h2><svg class="icon icon--sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5M12 3v1.5m0 15v1.5m9-9h-1.5M3.75 12H5.25m13.5 0a.75.75 0 01-1.5 0H5.25a.75.75 0 010-1.5h13.5a.75.75 0 010 1.5z" /></svg> Calendario ferie</h2>
    <p class="calendar-hint">Clicca su un giorno per vedere chi è in ferie. <span style="display:inline-flex;align-items:center;gap:.3rem;margin-left:.5rem"><span style="width:8px;height:8px;border-radius:50%;background:var(--primary,#3b82f6);display:inline-block"></span> Ferie</span> <span style="display:inline-flex;align-items:center;gap:.3rem;margin-left:.5rem"><span style="width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block"></span> Festività</span></p>
    <div class="calendar-nav">
      <button type="button" class="btn btn-sm calendar-prev" aria-label="Mese precedente"><span class="calendar-nav__arrow">‹</span><span class="calendar-nav__label">Prec</span></button>
      <h3 class="calendar-title" id="calendarMonthTitle">—</h3>
      <button type="button" class="btn btn-sm calendar-next" aria-label="Mese successivo"><span class="calendar-nav__label">Succ</span><span class="calendar-nav__arrow">›</span></button>
    </div>
    <div class="calendar-wrap">
      <div class="calendar-weekdays"><span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span><span>Dom</span></div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>
  </div>
</div>
<script>
(function(){
  var monthNames = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  var picker = document.getElementById('ferieDatepicker');
  var backdrop = document.getElementById('ferieDatepickerBackdrop');
  var gridEl = document.getElementById('ferieDatepickerGrid');
  var titleEl = picker && picker.querySelector('.ferie-datepicker__title');
  var currentField = null;
  var pickerYear = new Date().getFullYear();
  var pickerMonth = new Date().getMonth() + 1;

  function pad(n) { return n < 10 ? '0' + n : String(n); }
  function toYMD(y, m, d) { return y + '-' + pad(m) + '-' + pad(d); }
  function toDisplay(ymd) {
    if (!ymd) return 'Seleziona data';
    var p = ymd.split('-');
    return p[2] + '/' + p[1] + '/' + p[0];
  }
  function firstDayOffset(y, m) { return ((new Date(y, m - 1, 1).getDay() + 6) % 7); }
  function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }

  function openPicker(field) {
    currentField = field;
    var input = document.getElementById(field);
    if (input && input.value) {
      var p = input.value.split('-').map(Number);
      pickerYear = p[0];
      pickerMonth = p[1];
    } else {
      pickerYear = new Date().getFullYear();
      pickerMonth = new Date().getMonth() + 1;
    }
    renderPickerGrid();
    picker.removeAttribute('hidden');
    backdrop.removeAttribute('hidden');
  }

  function closePicker() {
    picker.setAttribute('hidden', '');
    backdrop.setAttribute('hidden', '');
    currentField = null;
  }

  function setDate(ymd) {
    if (!currentField) return;
    var input = document.getElementById(currentField);
    var trigger = document.querySelector('.ferie-date-trigger[data-field="' + currentField + '"]');
    if (input) input.value = ymd;
    if (trigger) {
      var t = trigger.querySelector('.ferie-date-trigger__text');
      if (t) t.textContent = toDisplay(ymd);
    }
    closePicker();
  }

  function renderPickerGrid() {
    if (!gridEl || !titleEl) return;
    titleEl.textContent = monthNames[pickerMonth - 1] + ' ' + pickerYear;
    var offset = firstDayOffset(pickerYear, pickerMonth);
    var days = daysInMonth(pickerYear, pickerMonth);
    var dataInizioVal = document.getElementById('data_inizio') && document.getElementById('data_inizio').value;
    var minTime = dataInizioVal && currentField === 'data_fine' ? new Date(dataInizioVal).getTime() : null;
    var html = '';
    for (var i = 0; i < offset; i++) html += '<span class="ferie-datepicker__day ferie-datepicker__day--empty"></span>';
    for (var d = 1; d <= days; d++) {
      var ymd = toYMD(pickerYear, pickerMonth, d);
      var dayTime = new Date(pickerYear, pickerMonth - 1, d).getTime();
      var disabled = minTime && dayTime < minTime;
      html += '<button type="button" class="ferie-datepicker__day" data-ymd="' + ymd + '"' + (disabled ? ' disabled' : '') + '>' + d + '</button>';
    }
    gridEl.innerHTML = html;
    gridEl.querySelectorAll('.ferie-datepicker__day:not(.ferie-datepicker__day--empty):not([disabled])').forEach(function(btn) {
      btn.addEventListener('click', function() { setDate(this.dataset.ymd); });
    });
  }

  if (picker && backdrop && gridEl) {
    document.querySelectorAll('.ferie-date-trigger').forEach(function(btn) {
      btn.addEventListener('click', function() { openPicker(this.dataset.field); });
    });
    picker.querySelector('.ferie-datepicker__prev').addEventListener('click', function() {
      pickerMonth--; if (pickerMonth < 1) { pickerMonth = 12; pickerYear--; }
      renderPickerGrid();
    });
    picker.querySelector('.ferie-datepicker__next').addEventListener('click', function() {
      pickerMonth++; if (pickerMonth > 12) { pickerMonth = 1; pickerYear++; }
      renderPickerGrid();
    });
    backdrop.addEventListener('click', closePicker);
  }
})();

  // Mostra/nascondi campo protocollo in base al tipo
  var tipoSelect = document.getElementById('tipo');
  var protocolloRow = document.getElementById('protocolloRow');
  var protocolloInput = document.getElementById('codice_protocollo');
  if (tipoSelect && protocolloRow) {
    tipoSelect.addEventListener('change', function() {
      if (this.value === 'malattia') { protocolloRow.style.display = ''; protocolloInput.required = true; }
      else { protocolloRow.style.display = 'none'; protocolloInput.required = false; protocolloInput.value = ''; }
    });
  }

  document.getElementById('frm').onsubmit=async function(e){
    e.preventDefault();
    var btn=this.querySelector('button[type="submit"]'), txt=btn ? btn.querySelector('.btn-text') : null, msg=document.getElementById('ferieMsg');
    msg.textContent=''; msg.className=''; msg.removeAttribute('class');
    if(btn) btn.disabled=true; if(txt) txt.textContent='Invio in corso...';
    try{
      var r=await fetch((window.APP_BASE||'')+'/ferie/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.fromEntries(new FormData(this)))});
      var j; try{j=await r.json();}catch(_){j={};}
      if(j.success){ msg.textContent=j.message||'Richiesta inviata'; msg.className='message-ok'; location.reload(); return; }
      msg.textContent=j.error||'Errore'; msg.className='message-error';
    }catch(x){ msg.textContent='Errore'; msg.className='message-error'; }
    if(btn) btn.disabled=false; if(txt) txt.textContent='Invia richiesta';
  };

  var base = window.APP_BASE || '', csrf = '<%= csrfToken %>';
  function openFerieEdit(id, inizio, fine, tipo, note, protocollo) {
    document.getElementById('ferieEditId').value = id;
    document.getElementById('ferieEditInizio').value = inizio;
    document.getElementById('ferieEditFine').value = fine;
    document.getElementById('ferieEditTipo').value = tipo || 'ferie';
    document.getElementById('ferieEditNote').value = note || '';
    document.getElementById('ferieEditProtocollo').value = protocollo || '';
    var editProtoRow = document.getElementById('editProtocolloRow');
    if (tipo === 'malattia') { editProtoRow.style.display = ''; } else { editProtoRow.style.display = 'none'; }
    document.getElementById('ferieEditOverlay').removeAttribute('hidden');
    document.getElementById('ferieEditOverlay').setAttribute('aria-hidden', 'false');
  }
  function closeFerieEdit() {
    document.getElementById('ferieEditOverlay').setAttribute('hidden', '');
    document.getElementById('ferieEditOverlay').setAttribute('aria-hidden', 'true');
  }
  document.querySelectorAll('.ferie-edit-btn').forEach(function(btn) {
    btn.onclick = function() { openFerieEdit(this.dataset.id, this.dataset.inizio, this.dataset.fine, this.dataset.tipo, this.dataset.note, this.dataset.protocollo); };
  });
  // Mostra/nascondi protocollo nel modale modifica
  var editTipoSelect = document.getElementById('ferieEditTipo');
  var editProtoRow = document.getElementById('editProtocolloRow');
  var editProtoInput = document.getElementById('ferieEditProtocollo');
  if (editTipoSelect && editProtoRow) {
    editTipoSelect.addEventListener('change', function() {
      if (this.value === 'malattia') { editProtoRow.style.display = ''; editProtoInput.required = true; }
      else { editProtoRow.style.display = 'none'; editProtoInput.required = false; editProtoInput.value = ''; }
    });
  }
  document.querySelectorAll('.ferie-withdraw-btn').forEach(function(btn) {
    btn.onclick = function() {
      var doWithdraw = function() {
        fetch(base + '/ferie/' + btn.dataset.id + '/withdraw', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ _csrf: csrf }) }).then(function(r) { return r.json(); }).then(function(j) {
          if (typeof window.showToast === 'function') window.showToast(j.message || j.error, j.success ? 'ok' : 'error');
          if (j.success) location.reload();
        });
      };
      if (typeof window.showModal === 'function') window.showModal({ title: 'Ritira richiesta', text: 'Ritirare questa richiesta? Non potrai più modificarla.', onConfirm: doWithdraw });
      else if (confirm('Ritirare questa richiesta?')) doWithdraw();
    };
  });
  document.getElementById('ferieEditCancel').onclick = closeFerieEdit;
  document.getElementById('ferieEditOverlay').onclick = function(e) { if (e.target === this) closeFerieEdit(); };
  document.getElementById('ferieEditForm').onsubmit = async function(e) {
    e.preventDefault();
    var id = document.getElementById('ferieEditId').value;
    var payload = { _csrf: csrf, data_inizio: document.getElementById('ferieEditInizio').value, data_fine: document.getElementById('ferieEditFine').value, tipo: document.getElementById('ferieEditTipo').value, note: document.getElementById('ferieEditNote').value, codice_protocollo: document.getElementById('ferieEditProtocollo').value };
    try {
      var r = await fetch(base + '/ferie/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      var j = await r.json();
      if (typeof window.showToast === 'function') window.showToast(j.message || j.error, j.success ? 'ok' : 'error');
      if (j.success) { closeFerieEdit(); location.reload(); }
    } catch (x) { if (typeof window.showToast === 'function') window.showToast('Errore', 'error'); }
  };

(function(){
  var monthNames = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  var year = new Date().getFullYear(), month = new Date().getMonth() + 1;
  var gridEl = document.getElementById('calendarGrid');
  var titleEl = document.getElementById('calendarMonthTitle');
  var byDate = {};
  var festivita = {};

  function firstDayOffset(y, m) { return ((new Date(y, m - 1, 1).getDay() + 6) % 7); }
  function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }

  function render() {
    titleEl.textContent = monthNames[month - 1] + ' ' + year;
    var offset = firstDayOffset(year, month);
    var days = daysInMonth(year, month);
    var html = '';
    for (var i = 0; i < offset; i++) html += '<span class="calendar-day calendar-day--empty"></span>';
    for (var d = 1; d <= days; d++) {
      var key = year + '-' + String(month).padStart(2,'0') + '-' + String(d).padStart(2,'0');
      var people = byDate[key] || [];
      var hasFerie = people.length > 0;
      var isFestivo = !!festivita[key];
      var festName = festivita[key] || '';
      var cls = 'calendar-day';
      if (hasFerie) cls += ' calendar-day--has';
      if (isFestivo) cls += ' calendar-day--festivo';

      var dots = '';
      if (hasFerie) dots += '<span class="calendar-day__dot" aria-hidden="true"></span>';
      if (isFestivo) dots += '<span class="calendar-day__dot calendar-day__dot--festivo" aria-hidden="true"></span>';

      var label = '';
      if (isFestivo) label = festName;
      else if (hasFerie) label = people.length + ' in ferie';

      var titleAttr = '';
      if (isFestivo && hasFerie) titleAttr = festName + ' — ' + people.length + ' in ferie';
      else if (isFestivo) titleAttr = festName;
      else if (hasFerie) titleAttr = people.length + ' in ferie';
      else titleAttr = 'Clicca per dettaglio';

      html += '<button type="button" class="' + cls + '" data-date="' + key + '" title="' + titleAttr + '">';
      html += '<span class="calendar-day__num">' + d + '</span>';
      html += dots;
      if (label) html += '<span class="calendar-day__label">' + label + '</span>';
      html += '</button>';
    }
    gridEl.innerHTML = html;
    gridEl.querySelectorAll('.calendar-day:not(.calendar-day--empty)').forEach(function(btn){
      btn.addEventListener('click', function(){
        var date = this.dataset.date;
        if (!date) return;
        var parts = date.split('-');
        var people = byDate[date] || [];
        var isFest = !!festivita[date];
        var lines = [];
        if (isFest) lines.push('Festività: ' + festivita[date]);
        if (people.length) lines.push(people.map(function(p){ return p.full_name; }).join('\n'));
        if (!lines.length) lines.push('Nessuno in ferie in questo giorno.');
        if (typeof window.showModal === 'function') window.showModal({ title: (isFest ? festivita[date] + ' — ' : '') + parts[2] + '/' + parts[1] + '/' + parts[0], text: lines.join('\n\n') });
      });
    });
  }

  function load() {
    fetch((window.APP_BASE||'')+'/ferie/calendar?year=' + year + '&month=' + month).then(function(r){ return r.json(); }).then(function(j){
      byDate = (j && typeof j.byDate === 'object' && j.byDate !== null) ? j.byDate : {};
      festivita = (j && typeof j.festivita === 'object' && j.festivita !== null) ? j.festivita : {};
      render();
    }).catch(function(){ byDate = {}; festivita = {}; render(); });
  }

  // Expose festivita for datepicker
  window._calFestivita = festivita;
  window._calLoadFestivita = function() { return festivita; };

  document.querySelector('.calendar-prev').addEventListener('click', function(){
    month--; if (month < 1) { month = 12; year--; }
    load();
  });
  document.querySelector('.calendar-next').addEventListener('click', function(){
    month++; if (month > 12) { month = 1; year++; }
    load();
  });
  load();
})();
</script>
