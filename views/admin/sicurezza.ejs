<% var bp = typeof basePath !== 'undefined' ? basePath : ''; %>
<h1 class="page-title animate-in">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
  Sicurezza sul Lavoro
</h1>

<!-- Statistiche -->
<div class="p-stats">
  <div class="p-stat p-stat--primary">
    <div class="p-stat__value"><%= stats.formazioni_attive %></div>
    <div class="p-stat__label">Formazioni</div>
  </div>
  <div class="p-stat <%= stats.formazioni_scadute > 0 ? 'p-stat--danger' : 'p-stat--success' %>">
    <div class="p-stat__value"><%= stats.formazioni_scadute %></div>
    <div class="p-stat__label">Scadute</div>
  </div>
  <div class="p-stat p-stat--primary">
    <div class="p-stat__value"><%= stats.dpi_attivi %></div>
    <div class="p-stat__label">DPI Attivi</div>
  </div>
  <div class="p-stat <%= stats.dpi_scaduti > 0 ? 'p-stat--danger' : 'p-stat--success' %>">
    <div class="p-stat__value"><%= stats.dpi_scaduti %></div>
    <div class="p-stat__label">DPI Scaduti</div>
  </div>
</div>

<% if (scadenze.totale > 0) { %>
<div class="p-alert p-alert--danger">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
  <strong class="p-alert__count"><%= scadenze.totale %> scadenze nei prossimi 30 giorni!</strong>
  <span class="p-alert__detail">
    <% if (scadenze.formazioni.length) { %><%= scadenze.formazioni.length %> formazioni<% } %>
    <% if (scadenze.dpi.length) { %> · <%= scadenze.dpi.length %> DPI<% } %>
  </span>
</div>
<% } %>

<!-- Filtro dipendente -->
<div class="p-filter">
  <form method="get" action="<%= bp %>/admin/sicurezza" class="p-filter__inner">
    <div class="p-filter__field">
      <span class="p-filter__label">Dipendente</span>
      <select name="user_id">
        <option value="">Tutti</option>
        <% (usersList || []).forEach(function(u) { %>
        <option value="<%= u.id %>"<%= filtri.user_id == u.id ? ' selected' : '' %>><%= u.full_name || u.username %></option>
        <% }); %>
      </select>
    </div>
    <input type="hidden" name="tab" value="<%= tab %>">
    <button type="submit" class="btn btn-sm">Filtra</button>
    <% if (filtri.user_id) { %><a href="<%= bp %>/admin/sicurezza?tab=<%= tab %>" class="btn btn-sm btn--secondary">Reset</a><% } %>
  </form>
</div>

<!-- Tabs -->
<div class="p-tabs">
  <a href="<%= bp %>/admin/sicurezza?tab=formazioni<%= filtri.user_id ? '&user_id=' + filtri.user_id : '' %>" class="p-tab<%= tab === 'formazioni' ? ' p-tab--active' : '' %>">Formazioni (<%= formazioni.length %>)</a>
  <a href="<%= bp %>/admin/sicurezza?tab=dpi<%= filtri.user_id ? '&user_id=' + filtri.user_id : '' %>" class="p-tab<%= tab === 'dpi' ? ' p-tab--active' : '' %>">DPI (<%= dpiConsegne.length %>)</a>
</div>

<!-- ===== TAB FORMAZIONI ===== -->
<% if (tab === 'formazioni') { %>
<div class="p-card" style="border-radius:0 0 var(--radius-lg) var(--radius-lg);border-top:0">
  <div class="p-card-header">
    <span class="p-list-item__sub"><%= formazioni.length %> formazioni</span>
    <button type="button" class="btn btn-sm" id="btnNewFormazione">+ Nuova formazione</button>
  </div>
  <% if (formazioni.length === 0) { %>
  <div class="p-empty"><p>Nessuna formazione registrata.</p></div>
  <% } else { %>
  <div class="p-card-body--flush">
    <% formazioni.forEach(function(f) { var scaduta = f.data_scadenza && new Date(f.data_scadenza) < new Date(); %>
    <div class="p-list-item<%= scaduta ? ' p-list-item--alert' : '' %>">
      <div class="p-list-item__avatar <%= scaduta ? 'p-list-item__avatar--danger' : 'p-list-item__avatar--primary' %>"><%= f.full_name ? f.full_name.charAt(0).toUpperCase() : '?' %></div>
      <div class="p-list-item__body">
        <div class="p-list-item__title">
          <span class="p-list-item__name"><%= f.full_name || f.username %></span>
          <span class="p-list-item__sub">@<%= f.username %></span>
        </div>
        <div class="p-list-item__meta">
          <strong><%= f.tipo %></strong>
          <% if (f.ente_formatore) { %><span>· <%= f.ente_formatore %></span><% } %>
          <span>· <%= f.data_corso %></span>
          <% if (f.ore) { %><span>· <%= f.ore %>h</span><% } %>
          <% if (f.data_scadenza) { %><span>· Scade: <strong style="color:<%= scaduta ? 'var(--danger)' : 'inherit' %>"><%= f.data_scadenza %></strong></span><% } %>
        </div>
      </div>
      <% if (scaduta) { %><span class="p-tag p-tag--danger">SCADUTA</span><% } %>
      <div class="p-list-item__actions">
        <button type="button" class="btn-sm sic-edit-btn" data-section="formazioni" data-id="<%= f.id %>" data-tipo="<%= f.tipo %>" data-descrizione="<%= f.descrizione || '' %>" data-ente="<%= f.ente_formatore || '' %>" data-corso="<%= f.data_corso %>" data-scadenza="<%= f.data_scadenza %>" data-ore="<%= f.ore || '' %>" data-stato="<%= f.stato %>">Modifica</button>
        <button type="button" class="btn-sm sic-del-btn" data-section="formazioni" data-id="<%= f.id %>">Elimina</button>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>
<% } %>

<!-- ===== TAB DPI ===== -->
<% if (tab === 'dpi') { %>
<div class="p-card" style="border-radius:0 0 var(--radius-lg) var(--radius-lg);border-top:0">
  <div class="p-card-header">
    <span class="p-list-item__sub"><%= dpiConsegne.length %> consegne DPI</span>
    <button type="button" class="btn btn-sm" id="btnNewDpi">+ Nuova consegna DPI</button>
  </div>
  <% if (dpiConsegne.length === 0) { %>
  <div class="p-empty"><p>Nessuna consegna DPI registrata.</p></div>
  <% } else { %>
  <div class="p-card-body--flush">
    <% dpiConsegne.forEach(function(d) { var scaduto = d.data_scadenza && new Date(d.data_scadenza) < new Date(); %>
    <div class="p-list-item<%= scaduto ? ' p-list-item--alert' : '' %>">
      <div class="p-list-item__avatar <%= scaduto ? 'p-list-item__avatar--danger' : 'p-list-item__avatar--success' %>">
        <svg style="width:18px;height:18px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
      </div>
      <div class="p-list-item__body">
        <div class="p-list-item__title">
          <span class="p-list-item__name"><%= d.full_name || d.username %></span>
          <span class="p-list-item__sub">@<%= d.username %></span>
        </div>
        <div class="p-list-item__meta">
          <strong><%= d.tipo_dpi %></strong>
          <% if (d.taglia) { %><span>· Tg. <%= d.taglia %></span><% } %>
          <span>· Qtà: <%= d.quantita %></span>
          <span>· <%= d.data_consegna %></span>
          <% if (d.data_scadenza) { %><span>· Scade: <strong style="color:<%= scaduto ? 'var(--danger)' : 'inherit' %>"><%= d.data_scadenza %></strong></span><% } %>
          <% if (d.lotto) { %><span>· Lotto: <%= d.lotto %></span><% } %>
        </div>
      </div>
      <% if (scaduto) { %><span class="p-tag p-tag--danger">SCADUTO</span><% } %>
      <div class="p-list-item__actions">
        <button type="button" class="btn-sm sic-edit-btn" data-section="dpi" data-id="<%= d.id %>" data-tipo="<%= d.tipo_dpi %>" data-descrizione="<%= d.descrizione || '' %>" data-taglia="<%= d.taglia || '' %>" data-quantita="<%= d.quantita %>" data-consegna="<%= d.data_consegna %>" data-scadenza="<%= d.data_scadenza %>" data-lotto="<%= d.lotto || '' %>" data-stato="<%= d.stato %>" data-note="<%= d.note || '' %>">Modifica</button>
        <button type="button" class="btn-sm sic-del-btn" data-section="dpi" data-id="<%= d.id %>">Elimina</button>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>
<% } %>

<!-- ===== MODALE CREAZIONE/MODIFICA ===== -->
<div id="sicModal" class="modal-overlay admin-ferie-modal" aria-hidden="true" hidden>
  <div class="modal admin-ferie-modal__box admin-ferie-modal__box--form" role="dialog" aria-modal="true" style="max-width:560px">
    <h3 class="modal__title" id="sicModalTitle">Nuovo</h3>
    <form id="sicForm" class="admin-ferie-edit-form p-modal-form">
      <input type="hidden" id="sicId" name="id">
      <input type="hidden" id="sicSection" name="section">
      <input type="hidden" id="sicMethod" name="_method" value="POST">
      <div id="sicFormFields"></div>
      <div class="modal__actions">
        <button type="button" class="btn btn--secondary" id="sicCancel">Annulla</button>
        <button type="submit" class="btn">Salva</button>
      </div>
    </form>
  </div>
</div>

<script>
var csrf = '<%= csrfToken %>';
var base = window.APP_BASE || '';
var usersList = <%- JSON.stringify((usersList || []).map(function(u) { return { id: u.id, name: u.full_name || u.username }; })) %>;

function usersSelect(selectedId) {
  var html = '<option value="">-- Seleziona --</option>';
  usersList.forEach(function(u) { html += '<option value="' + u.id + '"' + (selectedId == u.id ? ' selected' : '') + '>' + u.name + '</option>'; });
  return html;
}

var formFields = {
  formazioni: function(d) {
    return '<label>Dipendente <select id="sf_user_id" name="user_id" required' + (d ? ' disabled' : '') + '>' + usersSelect(d ? d.user_id : '') + '</select></label>' +
      '<label>Tipo corso <input type="text" id="sf_tipo" name="tipo" required placeholder="es. Primo soccorso, PES/PAV, Antincendio..." value="' + (d ? d.tipo : '') + '"></label>' +
      '<label>Ente formatore <input type="text" id="sf_ente" name="ente_formatore" placeholder="Opzionale" value="' + (d ? d.ente : '') + '"></label>' +
      '<div class="p-form-grid-2"><label>Data corso <input type="date" id="sf_corso" name="data_corso" required value="' + (d ? d.corso : '') + '"></label><label>Scadenza <input type="date" id="sf_scadenza" name="data_scadenza" value="' + (d ? d.scadenza : '') + '"></label></div>' +
      '<div class="p-form-grid-2"><label>Ore <input type="number" id="sf_ore" name="ore" min="0" value="' + (d ? d.ore : '') + '"></label><label>Stato <select id="sf_stato" name="stato"><option value="valido"' + (d && d.stato === 'valido' ? ' selected' : '') + '>Valido</option><option value="scaduto"' + (d && d.stato === 'scaduto' ? ' selected' : '') + '>Scaduto</option><option value="rinnovato"' + (d && d.stato === 'rinnovato' ? ' selected' : '') + '>Rinnovato</option></select></label></div>' +
      '<label>Descrizione <textarea id="sf_desc" name="descrizione" rows="2" placeholder="Opzionale">' + (d ? d.descrizione : '') + '</textarea></label>';
  },
  dpi: function(d) {
    return '<label>Dipendente <select id="sf_user_id" name="user_id" required' + (d ? ' disabled' : '') + '>' + usersSelect(d ? d.user_id : '') + '</select></label>' +
      '<label>Tipo DPI <input type="text" id="sf_tipo" name="tipo_dpi" required placeholder="es. Casco, guanti, scarpe..." value="' + (d ? d.tipo : '') + '"></label>' +
      '<div class="p-form-grid-3"><label>Taglia <input type="text" id="sf_taglia" name="taglia" placeholder="es. L, 42" value="' + (d ? d.taglia : '') + '"></label><label>Quantità <input type="number" id="sf_quantita" name="quantita" min="1" value="' + (d ? d.quantita : '1') + '"></label><label>Lotto <input type="text" id="sf_lotto" name="lotto" value="' + (d ? d.lotto : '') + '"></label></div>' +
      '<div class="p-form-grid-2"><label>Data consegna <input type="date" id="sf_consegna" name="data_consegna" required value="' + (d ? d.consegna : '') + '"></label><label>Scadenza <input type="date" id="sf_scadenza" name="data_scadenza" value="' + (d ? d.scadenza : '') + '"></label></div>' +
      '<label>Stato <select id="sf_stato" name="stato"><option value="consegnato"' + (d && d.stato === 'consegnato' ? ' selected' : '') + '>Consegnato</option><option value="sostituito"' + (d && d.stato === 'sostituito' ? ' selected' : '') + '>Sostituito</option><option value="restituito"' + (d && d.stato === 'restituito' ? ' selected' : '') + '>Restituito</option></select></label>' +
      '<label>Descrizione <textarea id="sf_desc" name="descrizione" rows="1" placeholder="Opzionale">' + (d ? d.descrizione : '') + '</textarea></label>' +
      '<label>Note <textarea id="sf_note" name="note" rows="1" placeholder="Opzionale">' + (d ? d.note : '') + '</textarea></label>';
  },
};

function openSicModal(section, title, data) {
  document.getElementById('sicModalTitle').textContent = title;
  document.getElementById('sicSection').value = section;
  document.getElementById('sicId').value = data ? data.id : '';
  document.getElementById('sicMethod').value = data ? 'PUT' : 'POST';
  document.getElementById('sicFormFields').innerHTML = formFields[section](data);
  document.getElementById('sicModal').removeAttribute('hidden');
  document.getElementById('sicModal').setAttribute('aria-hidden', 'false');
}
function closeSicModal() {
  document.getElementById('sicModal').setAttribute('hidden', '');
  document.getElementById('sicModal').setAttribute('aria-hidden', 'true');
}
document.getElementById('sicCancel').onclick = closeSicModal;
document.getElementById('sicModal').onclick = function(e) { if (e.target === this) closeSicModal(); };

// New buttons
var btnNew = {
  formazioni: document.getElementById('btnNewFormazione'),
  dpi: document.getElementById('btnNewDpi')
};
if (btnNew.formazioni) btnNew.formazioni.onclick = function() { openSicModal('formazioni', 'Nuova formazione', null); };
if (btnNew.dpi) btnNew.dpi.onclick = function() { openSicModal('dpi', 'Nuova consegna DPI', null); };

// Edit buttons
document.querySelectorAll('.sic-edit-btn').forEach(function(btn) {
  btn.onclick = function() {
    var s = this.dataset.section;
    var d = Object.assign({}, this.dataset);
    openSicModal(s, 'Modifica ' + s.slice(0, -1), d);
  };
});

// Delete buttons
document.querySelectorAll('.sic-del-btn').forEach(function(btn) {
  btn.onclick = function() {
    var section = this.dataset.section;
    var id = this.dataset.id;
    window.showModal({ title: 'Elimina', text: 'Eliminare definitivamente questo elemento?', onConfirm: async function() {
      try {
        var r = await fetch(base + '/admin/sicurezza/' + section + '/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ _csrf: csrf }) });
        var j = await r.json();
        window.showToast(j.message || j.error, j.success ? 'ok' : 'error');
        if (j.success) location.reload();
      } catch (x) { window.showToast('Errore', 'error'); }
    }});
  };
});

// Form submit
document.getElementById('sicForm').onsubmit = async function(e) {
  e.preventDefault();
  var section = document.getElementById('sicSection').value;
  var id = document.getElementById('sicId').value;
  var method = document.getElementById('sicMethod').value;
  var url = base + '/admin/sicurezza/' + section + (id ? '/' + id : '');
  var payload = Object.fromEntries(new FormData(this));
  payload._csrf = csrf;
  delete payload.section;
  delete payload._method;
  delete payload.id;
  try {
    var r = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    var j = await r.json();
    window.showToast(j.message || j.error, j.success ? 'ok' : 'error');
    if (j.success) { closeSicModal(); location.reload(); }
  } catch (x) { window.showToast('Errore', 'error'); }
};
</script>
