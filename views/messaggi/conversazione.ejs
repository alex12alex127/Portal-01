<%
  var bp = typeof basePath !== 'undefined' ? basePath : '';
  var _msgs = typeof messaggi !== 'undefined' ? messaggi : [];
  var _parts = typeof partecipanti !== 'undefined' ? partecipanti : [];
  var _userId = user ? user.id : 0;
%>

<!-- Header conversazione -->
<div class="msg-chat-header animate-in">
  <a href="<%= bp %>/messaggi" class="msg-chat-header__back" title="Torna ai messaggi">
    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
  </a>
  <div class="msg-chat-header__info">
    <h1 class="msg-chat-header__title"><%= conv.oggetto %></h1>
    <div class="msg-chat-header__partecipanti">
      <% _parts.forEach(function(p, i) { %>
        <span class="msg-chat-header__user <%= p.id === _userId ? 'msg-chat-header__user--me' : '' %>"><%= p.full_name %><% if (p.role === 'admin') { %> <span class="p-tag p-tag--primary" style="font-size:.55rem;padding:.1rem .3rem">Admin</span><% } else if (p.role === 'manager') { %> <span class="p-tag p-tag--warn" style="font-size:.55rem;padding:.1rem .3rem">Manager</span><% } %></span><%= i < _parts.length - 1 ? ', ' : '' %>
      <% }); %>
    </div>
  </div>
  <% if (conv.created_by === _userId) { %>
  <div class="msg-chat-header__actions">
    <form method="POST" action="<%= bp %>/messaggi/<%= conv.id %>/archivia" style="display:inline">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="submit" class="btn btn-sm btn--secondary" title="Archivia conversazione" style="font-size:.75rem">
        <svg class="icon" style="width:14px;height:14px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
        Archivia
      </button>
    </form>
  </div>
  <% } %>
</div>

<!-- Area messaggi -->
<div class="msg-chat-area p-card animate-in" id="chatArea">
  <div class="msg-chat-messages" id="chatMessages">
    <% if (_msgs.length === 0) { %>
      <div class="msg-chat-empty">
        <svg class="icon" style="width:40px;height:40px;opacity:.3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" /></svg>
        <p>Nessun messaggio. Scrivi il primo!</p>
      </div>
    <% } else { %>
      <% var lastDate = ''; %>
      <% _msgs.forEach(function(m) { %>
        <% var msgDate = new Date(m.created_at).toLocaleDateString('it-IT'); %>
        <% if (msgDate !== lastDate) { lastDate = msgDate; %>
          <div class="msg-chat-date-sep"><span><%= msgDate %></span></div>
        <% } %>
        <div class="msg-bubble <%= m.sender_id === _userId ? 'msg-bubble--mine' : 'msg-bubble--other' %>">
          <% if (m.sender_id !== _userId) { %>
            <div class="msg-bubble__sender">
              <span class="msg-bubble__name"><%= m.sender_name %></span>
              <% if (m.sender_role === 'admin') { %><span class="p-tag p-tag--primary" style="font-size:.5rem;padding:.05rem .25rem">Admin</span><% } else if (m.sender_role === 'manager') { %><span class="p-tag p-tag--warn" style="font-size:.5rem;padding:.05rem .25rem">Manager</span><% } %>
            </div>
          <% } %>
          <div class="msg-bubble__text"><%= m.testo %></div>
          <div class="msg-bubble__time"><%= new Date(m.created_at).toLocaleTimeString('it-IT', { hour:'2-digit', minute:'2-digit' }) %></div>
        </div>
      <% }); %>
    <% } %>
  </div>
</div>

<!-- Paginazione -->
<% if (typeof pagination !== 'undefined' && pagination.totalPages > 1) { %>
<div style="display:flex;justify-content:center;gap:.5rem;margin:.75rem 0;font-size:.85rem">
  <% if (pagination.page > 1) { %><a href="?page=<%= pagination.page - 1 %>" class="btn btn-sm btn--secondary">&larr; Precedenti</a><% } %>
  <span style="padding:.4rem .75rem;color:var(--text-muted)">Pagina <%= pagination.page %> di <%= pagination.totalPages %></span>
  <% if (pagination.page < pagination.totalPages) { %><a href="?page=<%= pagination.page + 1 %>" class="btn btn-sm btn--secondary">Successivi &rarr;</a><% } %>
</div>
<% } %>

<!-- Form invio messaggio -->
<div class="msg-chat-input animate-in">
  <form method="POST" action="<%= bp %>/messaggi/<%= conv.id %>/invia" id="formInviaMsg" class="msg-chat-input__form">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="msg-chat-input__wrap">
      <textarea name="testo" id="msgInput" placeholder="Scrivi un messaggio..." rows="1" required maxlength="2000" class="msg-chat-input__field"></textarea>
      <button type="submit" class="msg-chat-input__send" title="Invia">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
      </button>
    </div>
  </form>
</div>

<script>
(function(){
  var chatArea = document.getElementById('chatArea');
  var chatMsgs = document.getElementById('chatMessages');
  var input = document.getElementById('msgInput');
  var form = document.getElementById('formInviaMsg');
  var csrf = '<%= csrfToken %>';
  var base = window.APP_BASE || '';
  var convId = '<%= conv.id %>';
  var myId = <%= _userId %>;
  var POLL_MS = 3000;

  // Track last known message ID for polling
  var lastMsgId = 0;
  <% if (_msgs.length > 0) { %>
  lastMsgId = <%= _msgs[_msgs.length - 1].id %>;
  <% } %>

  // Track IDs we already rendered (server-rendered + optimistic)
  var renderedIds = {};
  <% _msgs.forEach(function(m) { %>
  renderedIds[<%= m.id %>] = true;
  <% }); %>

  // Auto-scroll to bottom on load
  if (chatArea) chatArea.scrollTop = chatArea.scrollHeight;

  // Check if user is scrolled near bottom
  function isNearBottom() {
    if (!chatArea) return true;
    return chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight < 80;
  }

  function scrollToBottom() {
    if (chatArea) chatArea.scrollTop = chatArea.scrollHeight;
  }

  // Auto-resize textarea
  if (input) {
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (this.value.trim()) form.dispatchEvent(new Event('submit'));
      }
    });
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatTime(dateStr) {
    var d = new Date(dateStr);
    return d.toLocaleTimeString('it-IT', { hour:'2-digit', minute:'2-digit' });
  }

  function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('it-IT');
  }

  // Render a single message bubble into the chat
  function renderBubble(msg) {
    var isMine = msg.sender_id === myId;
    var wasNear = isNearBottom();

    // Remove empty state if present
    var emptyEl = chatMsgs.querySelector('.msg-chat-empty');
    if (emptyEl) emptyEl.remove();

    // Date separator
    var msgDate = formatDate(msg.created_at);
    var lastDateSep = chatMsgs.querySelector('.msg-chat-date-sep:last-of-type');
    var lastDateStr = lastDateSep ? lastDateSep.querySelector('span').textContent : '';
    if (msgDate !== lastDateStr) {
      var sep = document.createElement('div');
      sep.className = 'msg-chat-date-sep';
      sep.innerHTML = '<span>' + escapeHtml(msgDate) + '</span>';
      chatMsgs.appendChild(sep);
    }

    var bubble = document.createElement('div');
    bubble.className = 'msg-bubble ' + (isMine ? 'msg-bubble--mine' : 'msg-bubble--other');
    bubble.dataset.msgId = msg.id;

    var html = '';
    if (!isMine) {
      html += '<div class="msg-bubble__sender">';
      html += '<span class="msg-bubble__name">' + escapeHtml(msg.sender_name) + '</span>';
      if (msg.sender_role === 'admin') html += ' <span class="p-tag p-tag--primary" style="font-size:.5rem;padding:.05rem .25rem">Admin</span>';
      else if (msg.sender_role === 'manager') html += ' <span class="p-tag p-tag--warn" style="font-size:.5rem;padding:.05rem .25rem">Manager</span>';
      html += '</div>';
    }
    html += '<div class="msg-bubble__text">' + escapeHtml(msg.testo) + '</div>';
    html += '<div class="msg-bubble__time">' + formatTime(msg.created_at) + '</div>';
    bubble.innerHTML = html;
    chatMsgs.appendChild(bubble);

    if (wasNear) scrollToBottom();
  }

  // ========== AJAX SEND ==========
  if (form) form.addEventListener('submit', async function(e) {
    e.preventDefault();
    var testo = input.value.trim();
    if (!testo) return;

    // Optimistic UI
    var emptyEl = chatMsgs.querySelector('.msg-chat-empty');
    if (emptyEl) emptyEl.remove();

    var tempBubble = document.createElement('div');
    tempBubble.className = 'msg-bubble msg-bubble--mine msg-bubble--sending';
    tempBubble.dataset.temp = 'true';
    tempBubble.innerHTML = '<div class="msg-bubble__text">' + escapeHtml(testo) + '</div><div class="msg-bubble__time">Invio...</div>';
    chatMsgs.appendChild(tempBubble);
    scrollToBottom();
    input.value = '';
    input.style.height = 'auto';

    try {
      var res = await fetch(base + '/messaggi/' + convId + '/invia', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-CSRF-Token': csrf },
        body: JSON.stringify({ testo: testo })
      });
      var data = await res.json();
      if (data.success && data.messaggio) {
        // Mark this ID so polling won't duplicate it
        renderedIds[data.messaggio.id] = true;
        if (data.messaggio.id > lastMsgId) lastMsgId = data.messaggio.id;
        // Update temp bubble
        tempBubble.classList.remove('msg-bubble--sending');
        tempBubble.dataset.msgId = data.messaggio.id;
        delete tempBubble.dataset.temp;
        var timeEl = tempBubble.querySelector('.msg-bubble__time');
        if (timeEl) timeEl.textContent = formatTime(data.messaggio.created_at);
      } else {
        tempBubble.classList.add('msg-bubble--error');
        tempBubble.querySelector('.msg-bubble__time').textContent = 'Errore invio';
      }
    } catch(err) {
      tempBubble.classList.add('msg-bubble--error');
      tempBubble.querySelector('.msg-bubble__time').textContent = 'Errore di rete';
    }
  });

  // ========== LIVE POLLING ==========
  var polling = true;

  async function pollNewMessages() {
    if (!polling) return;
    try {
      var res = await fetch(base + '/messaggi/' + convId + '/nuovi?after=' + lastMsgId, {
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      });
      if (res.status === 401) { polling = false; return; }
      var data = await res.json();
      if (data.success && data.messaggi && data.messaggi.length > 0) {
        data.messaggi.forEach(function(msg) {
          if (!renderedIds[msg.id]) {
            renderedIds[msg.id] = true;
            renderBubble(msg);
          }
          if (msg.id > lastMsgId) lastMsgId = msg.id;
        });
      }
    } catch(e) { /* silent */ }
  }

  var pollTimer = setInterval(pollNewMessages, POLL_MS);

  // Pause when tab hidden, resume + immediate poll when visible
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      polling = false;
    } else {
      polling = true;
      pollNewMessages();
    }
  });

  // Focus input on load
  if (input) input.focus();
})();
</script>
