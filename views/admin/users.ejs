<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
  Gestione Utenti
  <span class="text-muted" style="font-size:.9rem;font-weight:400;margin-left:.5rem">(<%= typeof pagination !== 'undefined' ? pagination.total : users.length %>)</span>
</h1>

<% if (typeof filtri !== 'undefined') { %>
<div class="card" style="margin-bottom:1rem">
  <form method="get" action="<%= typeof basePath !== 'undefined' ? basePath : '' %>/admin/users" style="display:flex;gap:.75rem;align-items:flex-end;flex-wrap:wrap">
    <div style="flex:1;min-width:180px">
      <label style="display:block;font-size:.8rem;font-weight:600;margin-bottom:.25rem;color:var(--muted)">Ricerca</label>
      <input type="search" name="q" placeholder="Nome, username, email..." value="<%= filtri.q || '' %>" style="width:100%">
    </div>
    <div style="min-width:120px">
      <label style="display:block;font-size:.8rem;font-weight:600;margin-bottom:.25rem;color:var(--muted)">Ruolo</label>
      <select name="role" style="width:100%">
        <option value="">Tutti</option>
        <option value="user"<%= filtri.role === 'user' ? ' selected' : '' %>>User</option>
        <option value="manager"<%= filtri.role === 'manager' ? ' selected' : '' %>>Manager</option>
        <option value="admin"<%= filtri.role === 'admin' ? ' selected' : '' %>>Admin</option>
      </select>
    </div>
    <button type="submit" class="btn btn-sm">Cerca</button>
    <% if (filtri.q || filtri.role) { %>
    <a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/admin/users" class="btn btn-sm btn--secondary">Reset</a>
    <% } %>
  </form>
</div>
<% } %>

<% if (users.length === 0) { %>
  <div class="card">
    <p class="empty">
      <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
      Nessun utente trovato.
    </p>
  </div>
<% } else { %>
  <div class="users-grid">
    <% users.forEach(function(u) { %>
    <div class="user-card <%= !u.is_active ? 'user-card--disabled' : '' %> <%= u.id === user.id ? 'user-card--self' : '' %>" data-id="<%= u.id %>">
      <div class="user-card__header">
        <div class="user-card__avatar"><%= u.full_name ? u.full_name.charAt(0).toUpperCase() : u.username.charAt(0).toUpperCase() %></div>
        <div class="user-card__info">
          <div class="user-card__name"><%= u.full_name %></div>
          <div class="user-card__username">@<%= u.username %></div>
        </div>
        <div class="user-card__badges">
          <span class="badge <%= u.is_active ? 'approved' : 'rejected' %>" style="font-size:.7rem"><%= u.is_active ? 'Attivo' : 'Disattivo' %></span>
          <% if (u.id === user.id) { %><span class="badge" style="background:var(--primary);color:#fff;font-size:.7rem;padding:.1rem .4rem;border-radius:999px">Tu</span><% } %>
        </div>
      </div>
      <div class="user-card__body">
        <div class="user-card__field">
          <span class="user-card__label">Email</span>
          <span class="user-card__value"><%= u.email %></span>
        </div>
        <div class="user-card__field">
          <span class="user-card__label">Ruolo</span>
          <% if (u.id !== user.id) { %>
          <select class="role-select user-card__role" data-id="<%= u.id %>">
            <option value="user" <%= u.role==='user'?'selected':'' %>>User</option>
            <option value="manager" <%= u.role==='manager'?'selected':'' %>>Manager</option>
            <option value="admin" <%= u.role==='admin'?'selected':'' %>>Admin</option>
          </select>
          <% } else { %>
          <span class="user-card__value" style="text-transform:capitalize"><%= u.role %></span>
          <% } %>
        </div>
        <div class="user-card__field">
          <span class="user-card__label">Registrato</span>
          <span class="user-card__value"><%= u.created_at ? new Date(u.created_at).toLocaleDateString('it-IT') : 'â€”' %></span>
        </div>
      </div>
      <% if (u.id !== user.id) { %>
      <div class="user-card__actions">
        <button type="button" class="btn-action btn-action--toggle" data-id="<%= u.id %>" title="<%= u.is_active ? 'Disattiva' : 'Attiva' %>">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1012.728 0M12 3v9" /></svg>
          <%= u.is_active ? 'Disattiva' : 'Attiva' %>
        </button>
        <button type="button" class="btn-action btn-action--reset" data-id="<%= u.id %>" title="Reset password">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
          Password
        </button>
        <button type="button" class="btn-action btn-action--del" data-id="<%= u.id %>" title="Elimina">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
          Elimina
        </button>
      </div>
      <% } %>
    </div>
    <% }); %>
  </div>

  <% if (typeof pagination !== 'undefined' && pagination.totalPages > 1) { %>
  <nav class="pagination" style="margin-top:1.5rem" aria-label="Paginazione">
    <span class="pagination__info">Pagina <%= pagination.page %> di <%= pagination.totalPages %></span>
    <div class="pagination__links">
      <% if (pagination.page > 1) { %><a href="?page=<%= pagination.page - 1 %>&limit=<%= pagination.limit %>&q=<%= (typeof filtri !== 'undefined' && filtri.q) || '' %>&role=<%= (typeof filtri !== 'undefined' && filtri.role) || '' %>" class="btn btn-sm">Precedente</a><% } %>
      <% if (pagination.page < pagination.totalPages) { %><a href="?page=<%= pagination.page + 1 %>&limit=<%= pagination.limit %>&q=<%= (typeof filtri !== 'undefined' && filtri.q) || '' %>&role=<%= (typeof filtri !== 'undefined' && filtri.role) || '' %>" class="btn btn-sm">Successivo</a><% } %>
    </div>
  </nav>
  <% } %>
<% } %>

<style>
.users-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:1rem; }
.user-card { background:var(--card-bg,#fff); border:1px solid var(--border,#e5e7eb); border-radius:12px; overflow:hidden; transition:box-shadow .2s, transform .2s; }
.user-card:hover { box-shadow:0 4px 16px rgba(0,0,0,.08); transform:translateY(-1px); }
.user-card--disabled { opacity:.6; }
.user-card--self { border-color:var(--primary); border-width:2px; }
.user-card__header { display:flex; align-items:center; gap:.75rem; padding:1rem 1.25rem; border-bottom:1px solid var(--border,#e5e7eb); }
.user-card__avatar { width:42px; height:42px; border-radius:50%; background:var(--primary,#4f46e5); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1.1rem; flex-shrink:0; }
.user-card__info { flex:1; min-width:0; }
.user-card__name { font-weight:600; font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.user-card__username { font-size:.8rem; color:var(--muted,#6b7280); }
.user-card__badges { display:flex; flex-direction:column; gap:.25rem; align-items:flex-end; }
.user-card__body { padding:1rem 1.25rem; display:flex; flex-direction:column; gap:.6rem; }
.user-card__field { display:flex; justify-content:space-between; align-items:center; gap:.5rem; }
.user-card__label { font-size:.8rem; font-weight:600; color:var(--muted,#6b7280); text-transform:uppercase; letter-spacing:.03em; }
.user-card__value { font-size:.9rem; color:var(--text); text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px; }
.user-card__role { font-size:.85rem; padding:.2rem .4rem; border:1px solid var(--border,#ddd); border-radius:6px; background:var(--bg,#fff); }
.user-card__actions { display:flex; gap:.5rem; padding:.75rem 1.25rem; border-top:1px solid var(--border,#e5e7eb); background:var(--bg-subtle,#f9fafb); }
.user-card__actions .btn-action { display:inline-flex; align-items:center; gap:.3rem; padding:.35rem .6rem; border:1px solid var(--border,#ddd); border-radius:6px; background:var(--card-bg,#fff); font-size:.78rem; cursor:pointer; color:var(--text); transition:all .15s; }
.user-card__actions .btn-action:hover { background:var(--primary,#4f46e5); color:#fff; border-color:var(--primary,#4f46e5); }
.user-card__actions .btn-action--del:hover { background:var(--danger,#ef4444); border-color:var(--danger,#ef4444); }
.user-card__actions .btn-action .icon { width:14px; height:14px; }
</style>
<script>
  var csrf='<%= csrfToken %>';
  document.querySelectorAll('.role-select').forEach(function(s){
    if(s.disabled)return;
    s.onchange=async function(){
      var id=this.dataset.id, sel=this, prev=this.value;
      this.disabled=true;
      try{
        var r=await fetch((window.APP_BASE||'')+'/admin/users/'+id+'/role',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role:this.value,_csrf:csrf})});
        var j=await r.json();
        window.showToast(j.message||j.error, j.success?'ok':'error');
      }catch(x){ window.showToast('Errore di connessione','error'); }
      this.disabled=false;
    };
  });
  document.querySelectorAll('.btn-action--toggle').forEach(function(btn){
    btn.onclick=function(){
      var id=btn.dataset.id;
      window.showModal({ title: 'Conferma', text: 'Attivare o disattivare questo utente?', onConfirm: async function(){
        btn.disabled=true;
        try{
          var r=await fetch((window.APP_BASE||'')+'/admin/users/'+id+'/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({_csrf:csrf})});
          var j=await r.json();
          window.showToast(j.message||j.error, j.success?'ok':'error');
          if(j.success) location.reload();
        }catch(x){ window.showToast('Errore','error'); }
        btn.disabled=false;
      }});
    };
  });
  document.querySelectorAll('.btn-action--reset').forEach(function(btn){
    btn.onclick=function(){
      window.promptModal({ title: 'Reset password', text: 'Nuova password (min 8 caratteri, maiuscole, minuscole, numeri):', placeholder: 'Nuova password', type: 'password' }, async function(p){
        if(!p) return;
        var id=btn.dataset.id; btn.disabled=true;
        try{
          var r=await fetch((window.APP_BASE||'')+'/admin/users/'+id+'/reset-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({new_password:p,_csrf:csrf})});
          var j=await r.json();
          window.showToast(j.message||j.error, j.success?'ok':'error');
        }catch(x){ window.showToast('Errore','error'); }
        btn.disabled=false;
      });
    };
  });
  document.querySelectorAll('.btn-action--del').forEach(function(btn){
    btn.onclick=function(){
      window.showModal({ title: 'Elimina utente', text: 'Eliminare definitivamente questo utente?', onConfirm: async function(){
        var id=btn.dataset.id; btn.disabled=true;
        try{
          var r=await fetch((window.APP_BASE||'')+'/admin/users/'+id,{method:'DELETE',headers:{'Content-Type':'application/json','X-CSRF-Token':csrf}});
          var j=await r.json();
          window.showToast(j.message||j.error, j.success?'ok':'error');
          if(j.success) location.reload();
        }catch(x){ window.showToast('Errore','error'); }
        btn.disabled=false;
      }});
    };
  });
</script>
