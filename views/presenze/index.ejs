<% var bp = typeof basePath !== 'undefined' ? basePath : ''; %>
<% var mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre']; %>
<h1 class="page-title animate-in">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
  Le mie presenze
</h1>

<!-- Timbratura veloce -->
<div class="p-card" style="margin-bottom:var(--space-md)">
  <div style="padding:var(--space-md);text-align:center">
    <div style="font-size:.82rem;color:var(--muted);margin-bottom:.5rem">Oggi, <%= new Date().toLocaleDateString('it-IT', {weekday:'long', day:'numeric', month:'long', year:'numeric'}) %></div>
    <% if (oggi && oggi.ora_entrata && oggi.ora_uscita) { %>
      <div class="p-tag p-tag--success" style="font-size:1rem;padding:.5rem 1rem">Giornata completata: <%= oggi.ora_entrata %> - <%= oggi.ora_uscita %> (<%= oggi.ore_lavorate %>h)</div>
    <% } else if (oggi && oggi.ora_entrata) { %>
      <div style="margin-bottom:.75rem">
        <span class="p-tag p-tag--primary" style="font-size:.9rem;padding:.4rem .8rem">Entrata: <%= oggi.ora_entrata %></span>
      </div>
      <button type="button" class="btn" id="btnUscita">Timbra Uscita</button>
    <% } else { %>
      <button type="button" class="btn" id="btnEntrata">Timbra Entrata</button>
    <% } %>
  </div>
</div>

<!-- Filtro mese -->
<div class="p-filter">
  <form method="get" action="<%= bp %>/presenze" class="p-filter__inner">
    <div class="p-filter__field">
      <span class="p-filter__label">Mese</span>
      <select name="mese" onchange="this.form.submit()">
        <% for (var m = 1; m <= 12; m++) { %>
        <option value="<%= m %>" <%= m === mese ? 'selected' : '' %>><%= mesi[m - 1] %></option>
        <% } %>
      </select>
    </div>
    <div class="p-filter__field">
      <span class="p-filter__label">Anno</span>
      <select name="anno" onchange="this.form.submit()">
        <% for (var y = new Date().getFullYear(); y >= new Date().getFullYear() - 2; y--) { %>
        <option value="<%= y %>" <%= y === anno ? 'selected' : '' %>><%= y %></option>
        <% } %>
      </select>
    </div>
  </form>
</div>

<!-- Riepilogo mensile -->
<div class="p-stats">
  <div class="p-stat p-stat--primary">
    <div class="p-stat__value"><%= riepilogo.giorniPresente %></div>
    <div class="p-stat__label">Giorni</div>
  </div>
  <div class="p-stat p-stat--success">
    <div class="p-stat__value"><%= riepilogo.oreTotali %></div>
    <div class="p-stat__label">Ore totali</div>
  </div>
  <div class="p-stat p-stat--warn">
    <div class="p-stat__value"><%= riepilogo.oreStraordinario %></div>
    <div class="p-stat__label">Straordinario</div>
  </div>
</div>

<!-- Lista presenze -->
<div class="p-card">
  <% if (riepilogo.presenze.length === 0) { %>
  <div class="p-empty"><p>Nessuna presenza registrata per questo mese.</p></div>
  <% } else { %>
  <div class="p-card-body--flush">
    <% riepilogo.presenze.forEach(function(p) {
      var d = new Date(p.data);
      var giorni = ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
      var giorno = giorni[d.getDay()];
    %>
    <div class="p-list-item">
      <div class="p-list-item__avatar p-list-item__avatar--primary" style="font-size:.7rem"><%= giorno %></div>
      <div class="p-list-item__body">
        <div class="p-list-item__title">
          <span class="p-list-item__name"><%= p.data %></span>
          <% if (p.tipo !== 'ordinario') { %><span class="p-tag p-tag--warn"><%= p.tipo.toUpperCase() %></span><% } %>
        </div>
        <div class="p-list-item__meta">
          <% if (p.ora_entrata) { %><span>Entrata: <strong><%= p.ora_entrata %></strong></span><% } %>
          <% if (p.ora_uscita) { %><span>路 Uscita: <strong><%= p.ora_uscita %></strong></span><% } %>
          <% if (p.ore_lavorate) { %><span>路 <strong><%= p.ore_lavorate %>h</strong></span><% } %>
          <% if (parseFloat(p.ore_straordinario) > 0) { %><span>路 Straord: <strong style="color:var(--warning)"><%= p.ore_straordinario %>h</strong></span><% } %>
          <% if (p.note) { %><span>路 <%= p.note %></span><% } %>
        </div>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>

<script>
var csrf = '<%= csrfToken %>', base = window.APP_BASE || '';
var btnE = document.getElementById('btnEntrata');
var btnU = document.getElementById('btnUscita');
if (btnE) btnE.onclick = async function() {
  try {
    var r = await fetch(base + '/presenze/entrata', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ _csrf: csrf }) });
    var j = await r.json();
    window.showToast(j.error || 'Entrata registrata alle ' + j.ora_entrata, j.error ? 'error' : 'ok');
    if (!j.error) location.reload();
  } catch (x) { window.showToast('Errore', 'error'); }
};
if (btnU) btnU.onclick = async function() {
  try {
    var r = await fetch(base + '/presenze/uscita', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ _csrf: csrf }) });
    var j = await r.json();
    window.showToast(j.error || 'Uscita registrata: ' + j.ore_lavorate + 'h lavorate', j.error ? 'error' : 'ok');
    if (!j.error) location.reload();
  } catch (x) { window.showToast('Errore', 'error'); }
};
</script>
