<%
  var bp = typeof basePath !== 'undefined' ? basePath : '';
  var _conv = typeof conversazioni !== 'undefined' ? conversazioni : [];
  var _utenti = typeof utenti !== 'undefined' ? utenti : [];
  var _nonLetti = typeof nonLetti !== 'undefined' ? nonLetti : 0;
%>
<h1 class="page-title animate-in">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" /></svg>
  Messaggi
  <% if (_nonLetti > 0) { %><span class="p-tag p-tag--primary" style="margin-left:.5rem;font-size:.75rem"><%= _nonLetti %> nuovi</span><% } %>
</h1>

<!-- Bottone nuova conversazione -->
<div style="display:flex;justify-content:flex-end;margin-bottom:1rem" class="animate-in">
  <button type="button" class="btn" id="btnNuovaConv" style="display:inline-flex;align-items:center;gap:.5rem">
    <svg class="icon" style="width:18px;height:18px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
    Nuova conversazione
  </button>
</div>

<!-- Lista conversazioni -->
<div class="p-card animate-in">
  <div class="p-card-header">
    <h3 class="p-card-header__title">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" /></svg>
      Conversazioni
    </h3>
    <span style="font-size:.8rem;color:var(--text-muted)"><%= _conv.length %> conversazion<%= _conv.length === 1 ? 'e' : 'i' %></span>
  </div>

  <% if (_conv.length === 0) { %>
    <div class="p-empty">
      <svg class="icon" style="width:48px;height:48px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" /></svg>
      <p>Nessuna conversazione. Inizia una nuova chat!</p>
    </div>
  <% } else { %>
    <div class="p-card-body--flush">
      <% _conv.forEach(function(c) { %>
      <a href="<%= bp %>/messaggi/<%= c.id %>" class="msg-conv-item <%= c.non_letti > 0 ? 'msg-conv-item--unread' : '' %>">
        <div class="msg-conv-item__avatar">
          <svg style="width:20px;height:20px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" /></svg>
        </div>
        <div class="msg-conv-item__body">
          <div class="msg-conv-item__top">
            <span class="msg-conv-item__oggetto"><%= c.oggetto %></span>
            <span class="msg-conv-item__time"><%= c.ultimo_messaggio_at ? new Date(c.ultimo_messaggio_at).toLocaleString('it-IT', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' }) : '' %></span>
          </div>
          <div class="msg-conv-item__partecipanti"><%= c.partecipanti_nomi || '' %></div>
          <div class="msg-conv-item__preview">
            <% if (c.ultimo_messaggio) { %>
              <span class="msg-conv-item__sender"><%= c.ultimo_messaggio_da ? c.ultimo_messaggio_da.split(' ')[0] + ':' : '' %></span>
              <%= c.ultimo_messaggio.substring(0, 80) %><%= c.ultimo_messaggio.length > 80 ? '...' : '' %>
            <% } else { %>
              <em style="opacity:.5">Nessun messaggio</em>
            <% } %>
          </div>
        </div>
        <% if (c.non_letti > 0) { %>
          <span class="msg-conv-item__badge"><%= c.non_letti %></span>
        <% } %>
      </a>
      <% }); %>
    </div>
  <% } %>
</div>

<!-- Modal nuova conversazione -->
<div class="modal-backdrop" id="modalNuovaConv" style="display:none">
  <div class="modal msg-modal-nuova">
    <div class="modal__header">
      <h3>Nuova conversazione</h3>
      <button type="button" class="modal__close" id="closeNuovaConv">&times;</button>
    </div>
    <form method="POST" action="<%= bp %>/messaggi/nuova" id="formNuovaConv">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="modal__body">
        <label style="display:block;margin-bottom:var(--space)">
          <span style="font-size:.85rem;font-weight:600;display:block;margin-bottom:.25rem">Oggetto</span>
          <input type="text" name="oggetto" required placeholder="Oggetto della conversazione..." class="form-control" maxlength="255">
        </label>
        <label style="display:block;margin-bottom:var(--space)">
          <span style="font-size:.85rem;font-weight:600;display:block;margin-bottom:.25rem">Destinatari</span>
          <select name="destinatari" required multiple class="form-control msg-select-dest" style="min-height:120px">
            <% _utenti.forEach(function(u) { %>
              <option value="<%= u.id %>"><%= u.full_name %> (<%= u.role %>)</option>
            <% }); %>
          </select>
          <small style="color:var(--text-muted);font-size:.75rem">Tieni premuto Ctrl/Cmd per selezionare pi√π utenti</small>
        </label>
        <label style="display:block;margin-bottom:var(--space)">
          <span style="font-size:.85rem;font-weight:600;display:block;margin-bottom:.25rem">Messaggio (opzionale)</span>
          <textarea name="messaggio" rows="3" placeholder="Scrivi il primo messaggio..." class="form-control" maxlength="2000"></textarea>
        </label>
      </div>
      <div class="modal__footer">
        <button type="button" class="btn btn--secondary" id="cancelNuovaConv">Annulla</button>
        <button type="submit" class="btn">
          <svg class="icon" style="width:16px;height:16px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
          Crea conversazione
        </button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  var modal = document.getElementById('modalNuovaConv');
  var btnOpen = document.getElementById('btnNuovaConv');
  var btnClose = document.getElementById('closeNuovaConv');
  var btnCancel = document.getElementById('cancelNuovaConv');

  function openModal() { modal.style.display = 'flex'; }
  function closeModal() { modal.style.display = 'none'; }

  if (btnOpen) btnOpen.addEventListener('click', openModal);
  if (btnClose) btnClose.addEventListener('click', closeModal);
  if (btnCancel) btnCancel.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });
  document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });
})();
</script>
