<% var bp = typeof basePath !== 'undefined' ? basePath : ''; %>
<% var totRichieste=0, totGiorni=0; byStato.forEach(function(s){totRichieste+=s.n; totGiorni+=s.giorni}); %>
<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
  Report Ferie <%= year %>
</h1>

<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.75rem;margin-bottom:1.5rem">
  <form method="get" action="<%= bp %>/admin/report" style="display:flex;gap:.5rem;align-items:center">
    <label style="font-size:.8rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.03em">Anno</label>
    <select name="year" onchange="this.form.submit()" style="min-width:100px">
      <% (anni || []).forEach(function(y) { %>
      <option value="<%= y %>"<%= y === year ? ' selected' : '' %>><%= y %></option>
      <% }); %>
      <% if (!anni || !anni.includes(year)) { %>
      <option value="<%= year %>" selected><%= year %></option>
      <% } %>
    </select>
  </form>
  <a href="<%= bp %>/admin/report/export?year=<%= year %>" class="btn btn-sm" style="display:inline-flex;align-items:center;gap:.4rem">
    <svg style="width:14px;height:14px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
    Esporta CSV
  </a>
</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-bottom:1.5rem">
  <div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:1.25rem;text-align:center">
    <div style="font-size:2rem;font-weight:700;color:var(--primary,#4f46e5)"><%= totRichieste %></div>
    <div style="font-size:.8rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.03em;margin-top:.25rem">Richieste</div>
  </div>
  <div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:1.25rem;text-align:center">
    <div style="font-size:2rem;font-weight:700;color:var(--text)"><%= totGiorni %></div>
    <div style="font-size:.8rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.03em;margin-top:.25rem">Giorni totali</div>
  </div>
  <% byStato.forEach(function(s) { %>
  <div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:1.25rem;text-align:center">
    <div style="font-size:2rem;font-weight:700;color:<%= s.stato === 'approved' ? 'var(--success,#22c55e)' : s.stato === 'pending' ? 'var(--warn,#f59e0b)' : 'var(--danger,#ef4444)' %>"><%= s.n %></div>
    <div style="font-size:.8rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.03em;margin-top:.25rem"><%= s.stato === 'pending' ? 'In attesa' : s.stato === 'approved' ? 'Approvate' : 'Rifiutate' %> (<%= s.giorni %>gg)</div>
  </div>
  <% }); %>
</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1rem;margin-bottom:1.5rem">

  <div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;overflow:hidden">
    <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--border,#e5e7eb);font-weight:600;display:flex;align-items:center;gap:.5rem">
      <svg style="width:18px;height:18px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>
      Per Tipo
    </div>
    <% if (byTipo.length === 0) { %>
      <div style="padding:2rem;text-align:center;color:var(--muted)">Nessun dato</div>
    <% } else { %>
      <div style="padding:.5rem 0">
        <% byTipo.forEach(function(t) { %>
        <div style="display:flex;align-items:center;gap:.75rem;padding:.6rem 1.25rem;border-bottom:1px solid var(--border,#f3f4f6)">
          <span style="flex:1;font-size:.9rem;font-weight:500;text-transform:capitalize"><%= t.tipo === 'ferie' ? 'Ferie' : t.tipo === 'permesso' ? 'Permesso' : t.tipo === 'malattia' ? 'Malattia' : t.tipo %></span>
          <span style="font-size:.85rem;color:var(--muted)"><%= t.n %> richieste</span>
          <span style="font-weight:600;font-size:.9rem"><%= t.giorni %> gg</span>
        </div>
        <% }); %>
      </div>
    <% } %>
  </div>

  <div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;overflow:hidden">
    <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--border,#e5e7eb);font-weight:600;display:flex;align-items:center;gap:.5rem">
      <svg style="width:18px;height:18px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
      Per Mese (approvate)
    </div>
    <% if (byMese.length === 0) { %>
      <div style="padding:2rem;text-align:center;color:var(--muted)">Nessun dato</div>
    <% } else { %>
      <div style="display:flex;align-items:flex-end;gap:4px;height:140px;padding:1.25rem 1.25rem .75rem">
        <% var maxG = Math.max.apply(null, byMese.map(function(m){return m.giorni})) || 1; %>
        <% var mesiNomi = ['','Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic']; %>
        <% for (var mi=1; mi<=12; mi++) { var found = byMese.find(function(m){return m.mese===mi}); var g = found ? found.giorni : 0; var pct = Math.round(g/maxG*100); %>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px">
          <span style="font-size:.7rem;color:var(--muted);font-weight:600"><%= g || '' %></span>
          <div style="width:100%;background:var(--primary,#4f46e5);border-radius:4px 4px 0 0;min-height:2px;height:<%= pct %>%;transition:height .3s" title="<%= mesiNomi[mi] %>: <%= g %> giorni"></div>
          <span style="font-size:.65rem;color:var(--muted)"><%= mesiNomi[mi] %></span>
        </div>
        <% } %>
      </div>
    <% } %>
  </div>

</div>

<div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;overflow:hidden">
  <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--border,#e5e7eb);font-weight:600;display:flex;align-items:center;gap:.5rem">
    <svg style="width:18px;height:18px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
    Per Dipendente
  </div>
  <% if (byUser.length === 0) { %>
    <div style="padding:2rem;text-align:center;color:var(--muted)">Nessun dato</div>
  <% } else { %>
    <div>
      <% byUser.forEach(function(u) { %>
      <div style="display:flex;align-items:center;gap:1rem;padding:.75rem 1.25rem;border-bottom:1px solid var(--border,#f3f4f6)">
        <div style="width:36px;height:36px;border-radius:50%;background:var(--primary,#4f46e5);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;flex-shrink:0"><%= u.full_name ? u.full_name.charAt(0).toUpperCase() : '?' %></div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:.9rem"><%= u.full_name %></div>
          <div style="font-size:.75rem;color:var(--muted)">@<%= u.username %> Â· <%= u.richieste %> richieste</div>
        </div>
        <div style="display:flex;gap:1rem;text-align:center">
          <div>
            <div style="font-weight:700;font-size:1rem;color:var(--success,#22c55e)"><%= u.giorni_approvati %></div>
            <div style="font-size:.65rem;color:var(--muted);text-transform:uppercase">Approvati</div>
          </div>
          <div>
            <div style="font-weight:700;font-size:1rem;color:var(--warn,#f59e0b)"><%= u.giorni_pending %></div>
            <div style="font-size:.65rem;color:var(--muted);text-transform:uppercase">In attesa</div>
          </div>
          <div>
            <div style="font-weight:700;font-size:1rem"><%= u.giorni_approvati + u.giorni_pending %></div>
            <div style="font-size:.65rem;color:var(--muted);text-transform:uppercase">Totale</div>
          </div>
        </div>
      </div>
      <% }); %>
    </div>
  <% } %>
</div>
