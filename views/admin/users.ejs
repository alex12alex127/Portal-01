<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Utenti - Portal-01</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="app-wrap">
    <%- include('../partials/sidebar', { user: user, activePage: 'admin' }) %>
    <main class="main">
      <div class="container">
        <h1>Gestione Utenti</h1>
        <div class="card">
          <h2>Utenti (<%= users.length %>)</h2>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Username</th><th>Nome</th><th>Email</th><th>Ruolo</th><th>Stato</th><th>Azioni</th></tr>
              </thead>
              <tbody>
                <% users.forEach(function(u) { %>
                <tr data-id="<%= u.id %>">
                  <td><strong><%= u.username %></strong></td>
                  <td><%= u.full_name %></td>
                  <td><%= u.email %></td>
                  <td>
                    <select class="role-select" data-id="<%= u.id %>" <%= u.id === user.id ? 'disabled' : '' %>>
                      <option value="user" <%= u.role==='user'?'selected':'' %>>user</option>
                      <option value="manager" <%= u.role==='manager'?'selected':'' %>>manager</option>
                      <option value="admin" <%= u.role==='admin'?'selected':'' %>>admin</option>
                    </select>
                  </td>
                  <td><span class="badge <%= u.is_active?'approved':'rejected' %>"><%= u.is_active?'Attivo':'Disattivo' %></span></td>
                  <td>
                    <% if (u.id !== user.id) { %>
                      <button type="button" class="btn-sm toggle" data-id="<%= u.id %>"><%= u.is_active?'Disattiva':'Attiva' %></button>
                      <button type="button" class="btn-sm reset" data-id="<%= u.id %>">Reset pwd</button>
                      <button type="button" class="btn-sm del" data-id="<%= u.id %>">Elimina</button>
                    <% } else { %>â€”<% } %>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    var csrf='<%= csrfToken %>';
    document.querySelectorAll('.role-select').forEach(function(s){
      if(s.disabled)return;
      s.onchange=async function(){
        var id=this.dataset.id,r=await fetch('/admin/users/'+id+'/role',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({role:this.value,_csrf:csrf})});
        var j=await r.json();alert(j.message||j.error);
      };
    });
    document.querySelectorAll('.toggle').forEach(function(b){
      b.onclick=async function(){if(!confirm('Confermi?'))return;var id=this.dataset.id,r=await fetch('/admin/users/'+id+'/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({_csrf:csrf})});var j=await r.json();alert(j.message||j.error);if(j.success)location.reload();};
    });
    document.querySelectorAll('.reset').forEach(function(b){
      b.onclick=async function(){var p=prompt('Nuova password (min 8 caratteri)');if(!p)return;var id=this.dataset.id,r=await fetch('/admin/users/'+id+'/reset-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({new_password:p,_csrf:csrf})});var j=await r.json();alert(j.message||j.error);};
    });
    document.querySelectorAll('.del').forEach(function(b){
      b.onclick=async function(){if(!confirm('Eliminare utente?'))return;var id=this.dataset.id,r=await fetch('/admin/users/'+id,{method:'DELETE',headers:{'Content-Type':'application/json','X-CSRF-Token':csrf}});var j=await r.json();alert(j.message||j.error);if(j.success)location.reload();};
    });
  </script>
</body>
</html>
