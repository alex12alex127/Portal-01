<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
  Avvisi
  <% if (nonLetti > 0) { %><span class="badge badge--alert" style="margin-left:.5rem"><%= nonLetti %></span><% } %>
</h1>

<% if (avvisi.length === 0) { %>
  <div class="card">
    <p class="empty">
      <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
      Nessun avviso disponibile al momento.
    </p>
  </div>
<% } else { %>
  <div class="avvisi-list">
    <% avvisi.forEach(function(a) { %>
    <div class="card avviso-card <%= a.in_evidenza ? 'avviso-card--evidenza' : '' %> <%= a.letto ? 'avviso-card--letto' : '' %>" data-id="<%= a.id %>">
      <div class="avviso-card__header">
        <span class="badge badge--avviso badge--<%= a.tipo %>"><%= a.tipo === 'info' ? 'Info' : a.tipo === 'warning' ? 'Attenzione' : a.tipo === 'urgent' ? 'Urgente' : a.tipo === 'success' ? 'Successo' : a.tipo %></span>
        <% if (a.in_evidenza) { %><span class="badge badge--evidenza">In evidenza</span><% } %>
        <span class="text-muted" style="margin-left:auto;font-size:.85rem"><%= a.created_at ? new Date(a.created_at).toLocaleDateString('it-IT') : '' %></span>
      </div>
      <h2 class="avviso-card__title"><a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/avvisi/<%= a.id %>"><%= a.titolo %></a></h2>
      <% if (a.contenuto) { %>
        <p class="avviso-card__excerpt"><%= a.contenuto.length > 200 ? a.contenuto.substring(0, 200) + '...' : a.contenuto %></p>
      <% } %>
      <div class="avviso-card__footer">
        <% if (a.autore_nome) { %><span class="text-muted"><%= a.autore_nome %></span><% } %>
        <% if (!a.letto) { %>
          <button type="button" class="btn btn-sm btn-mark-read" data-id="<%= a.id %>">Segna come letto</button>
        <% } else { %>
          <span class="text-muted" style="font-size:.85rem">Letto</span>
        <% } %>
      </div>
    </div>
    <% }); %>
  </div>
<% } %>

<style>
.avvisi-list { display:flex; flex-direction:column; gap:1rem }
.avviso-card { transition:all .2s }
.avviso-card:hover { box-shadow:0 4px 12px rgba(0,0,0,.08) }
.avviso-card--evidenza { border-left:4px solid var(--primary) }
.avviso-card--letto { opacity:.75 }
.avviso-card__header { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; margin-bottom:.75rem }
.avviso-card__title { margin:0 0 .5rem; font-size:1.25rem }
.avviso-card__title a { color:var(--text); text-decoration:none }
.avviso-card__title a:hover { color:var(--primary) }
.avviso-card__excerpt { color:var(--muted); margin:0 0 .75rem; line-height:1.5; white-space:pre-wrap; word-break:break-word }
.avviso-card__footer { display:flex; justify-content:space-between; align-items:center; gap:.5rem }
.badge--evidenza { background:var(--primary); color:#fff; padding:.15rem .5rem; border-radius:999px; font-size:.75rem }
</style>

<script>
(function(){
  var base = window.APP_BASE || '';
  function showMsg(txt, ok) {
    var el = document.createElement('div');
    el.textContent = txt;
    el.style.cssText = 'position:fixed;top:1rem;right:1rem;padding:.75rem 1.25rem;border-radius:var(--radius);color:#fff;font-weight:500;z-index:9999;background:' + (ok ? 'var(--success,#22c55e)' : 'var(--danger,#ef4444)');
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }

  document.addEventListener('click', async function(e) {
    var btn = e.target.closest('.btn-mark-read');
    if (!btn) return;
    var id = btn.dataset.id;
    try {
      var r = await fetch(base + '/avvisi/' + id + '/letta', { method:'POST', headers:{'Content-Type':'application/json'} });
      var data = await r.json();
      if (data.success) {
        var card = document.querySelector('.avviso-card[data-id="' + id + '"]');
        if (card) { card.classList.add('avviso-card--letto'); }
        btn.replaceWith(Object.assign(document.createElement('span'), { className:'text-muted', style:'font-size:.85rem', textContent:'Letto' }));
        showMsg('Avviso segnato come letto', true);
      } else { showMsg(data.error || 'Errore', false); }
    } catch(err) { showMsg('Errore di rete', false); }
  });
})();
</script>
