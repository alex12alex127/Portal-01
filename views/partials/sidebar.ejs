<% const active = typeof activePage !== 'undefined' ? activePage : ''; const bp = typeof basePath !== 'undefined' ? basePath : ''; %>
<aside class="sidebar" id="sidebar">
  <div class="sidebar__head">
    <a href="<%= bp %>/dashboard" class="sidebar__brand">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
      Portal-01
    </a>
    <button type="button" class="sidebar__close" id="sidebarClose" aria-label="Chiudi">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
    </button>
  </div>
  <div class="sidebar__search" style="padding:.5rem .75rem">
    <div style="position:relative">
      <input type="search" id="globalSearch" placeholder="Cerca..." autocomplete="off" style="width:100%;padding:.4rem .6rem .4rem 2rem;border:1px solid var(--border,#ddd);border-radius:6px;font-size:.85rem;background:var(--bg,#fff)">
      <svg style="position:absolute;left:.5rem;top:50%;transform:translateY(-50%);width:14px;height:14px;opacity:.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
      <div id="searchResults" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--card-bg,#fff);border:1px solid var(--border,#ddd);border-radius:6px;margin-top:4px;max-height:250px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.15)"></div>
    </div>
  </div>
  <nav class="sidebar__nav">
    <a href="<%= bp %>/dashboard" class="sidebar__link <%= active === 'dashboard' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
      Panoramica
    </a>
    <a href="<%= bp %>/ferie" class="sidebar__link <%= active === 'ferie' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>
      Ferie
    </a>
    <a href="<%= bp %>/avvisi" class="sidebar__link <%= active === 'avvisi' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      Avvisi
      <% if (typeof avvisiNonLetti !== 'undefined' && avvisiNonLetti > 0) { %>
        <span class="notification-badge" style="display: inline-block;"><%= avvisiNonLetti %></span>
      <% } %>
    </a>
    <a href="<%= bp %>/notifiche" class="sidebar__link <%= active === 'notifiche' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
      Notifiche
      <% if (typeof notificheNonLette !== 'undefined' && notificheNonLette > 0) { %>
        <span class="notification-badge" style="display: inline-block;"><%= notificheNonLette %></span>
      <% } %>
    </a>
    <a href="<%= bp %>/profile" class="sidebar__link <%= active === 'profile' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
      Profilo
    </a>
    <% if (user && (user.role === 'admin' || user.role === 'manager')) { %>
    <span class="sidebar__group-label">Amministrazione</span>
    <% if (user.role === 'admin') { %>
    <a href="<%= bp %>/admin/users" class="sidebar__link <%= active === 'admin' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197zM4.343 10.293a1 1 0 011.414 0l7 7a1 1 0 01-1.414 1.414l-7-7a1 1 0 011.414-1.414zM10.206 16.657a1 1 0 010-1.414l-7-7a1 1 0 011.586 1.586l7 7a1 1 0 01-1.586 1.586z" /></svg>
      Gestione Utenti
    </a>
    <% } %>
    <a href="<%= bp %>/admin/ferie" class="sidebar__link <%= active === 'adminFerie' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2l-4-4 2 2" /></svg>
      Approva Ferie
    </a>
    <a href="<%= bp %>/admin/avvisi" class="sidebar__link <%= active === 'adminAvvisi' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
      Gestione Avvisi
    </a>
    <% if (user.role === 'admin') { %>
    <a href="<%= bp %>/admin/report" class="sidebar__link <%= active === 'adminReport' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
      Report Ferie
    </a>
    <a href="<%= bp %>/admin/audit" class="sidebar__link <%= active === 'adminAudit' ? 'active' : '' %>">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
      Audit Log
    </a>
    <% } %>
    <% } %>
  </nav>
  <div class="sidebar__foot">
    <button type="button" class="sidebar__link theme-toggle" id="themeToggle" aria-label="Tema chiaro/scuro" title="Cambia tema">
      <svg class="icon icon--theme-light" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
      <svg class="icon icon--theme-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
      <span class="theme-toggle__label">Tema</span>
    </button>
    <% if (user) { %><p class="sidebar__user"><%= user.full_name %></p><% } %>
    <a href="<%= bp %>/auth/logout" class="sidebar__link logout">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v3.75M15.75 9L12 12.75m0 0L8.25 9m3.75 3.75V21" /></svg>
      Esci
    </a>
  </div>
</aside>
<button type="button" class="sidebar__toggle" id="sidebarToggle" aria-label="Menu">
  <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
</button>
<div class="sidebar__backdrop" id="sidebarBackdrop"></div>
<script>
(function(){
  var s=document.getElementById('sidebar'),t=document.getElementById('sidebarToggle'),c=document.getElementById('sidebarClose'),b=document.getElementById('sidebarBackdrop');
  if(!s||!t)return;
  function open(){s.classList.add('open');if(b)b.classList.add('open');document.body.style.overflow='hidden';}
  function close(){s.classList.remove('open');if(b)b.classList.remove('open');document.body.style.overflow='';}
  t.addEventListener('click',function(e){e.preventDefault();open();});
  if(c)c.addEventListener('click',function(e){e.preventDefault();close();});
  if(b)b.addEventListener('click',function(e){e.preventDefault();close();});
})();
(function(){
  var urls=['<%= bp %>/dashboard','<%= bp %>/ferie','<%= bp %>/avvisi','<%= bp %>/profile'<% if (user && user.role === 'admin') { %>,'<%= bp %>/admin/users'<% } %><% if (user && (user.role === 'admin' || user.role === 'manager')) { %>,'<%= bp %>/admin/ferie','<%= bp %>/admin/avvisi'<% } %>];
  function prefetch(){ urls.forEach(function(u){ var l=document.createElement('link'); l.rel='prefetch'; l.href=u; document.head.appendChild(l); }); }
  if(document.readyState==='complete') setTimeout(prefetch,300); else window.addEventListener('load',function(){ setTimeout(prefetch,300); });
})();
(function(){
  var stored = localStorage.getItem('portal-theme');
  var dark = stored === 'dark' || (!stored && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
  if (dark) document.documentElement.setAttribute('data-theme', 'dark');
  var btn = document.getElementById('themeToggle');
  if (btn) btn.addEventListener('click', function() {
    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) { document.documentElement.removeAttribute('data-theme'); localStorage.setItem('portal-theme', 'light'); }
    else { document.documentElement.setAttribute('data-theme', 'dark'); localStorage.setItem('portal-theme', 'dark'); }
  });
})();
</script>
