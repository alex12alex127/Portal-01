<div class="notifications-page">
  <div class="page-header">
    <h1>Notifiche</h1>
    <div class="notification-actions">
      <button class="btn btn-secondary btn-mark-all-read" style="display: none;">
        Marca tutte come lette (0)
      </button>
      <button class="btn btn-danger btn-delete-all" title="Elimina tutte le notifiche" style="display: none;">
        üóëÔ∏è Elimina tutte
      </button>
      <button class="btn btn-primary btn-refresh">
        <i class="icon">üîÑ</i> Aggiorna
      </button>
    </div>
  </div>

  <div class="notifications-list" id="notificationsList">
    <!-- Le notifiche verranno caricate via JavaScript -->
    <div class="loading">Caricamento notifiche...</div>
  </div>
</div>

<style>
.notifications-page {
  max-width: 800px;
  margin: 0 auto;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}

.notification-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.notifications-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.notification-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1rem;
  display: flex;
  gap: 1rem;
  align-items: flex-start;
  cursor: pointer;
  transition: all 0.2s ease;
}

.notification-item:hover {
  border-color: var(--primary);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.notification-item.unread {
  border-left: 4px solid var(--primary);
  background: var(--surface);
}

.notification-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.notification-icon.info { background: var(--primary-light); color: var(--primary); }
.notification-icon.success { background: var(--success-light); color: var(--success); }
.notification-icon.warning { background: var(--warn-light); color: var(--warn); }
.notification-icon.error { background: var(--danger-light); color: var(--danger); }

.notification-content {
  flex: 1;
  min-width: 0;
}

.notification-title {
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: var(--text);
}

.notification-message {
  color: var(--muted);
  font-size: 0.9rem;
  line-height: 1.4;
}

.notification-time {
  font-size: 0.8rem;
  color: var(--muted);
  margin-top: 0.5rem;
}

.notification-actions-item {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.btn-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  transition: background 0.2s ease;
}

.btn-icon:hover {
  background: var(--border);
}

.empty-notifications {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--muted);
}

.empty-notifications .icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.loading {
  text-align: center;
  padding: 2rem;
  color: var(--muted);
}
</style>

<script>
// Variabili globali
let notifications = [];
let basePath = window.APP_BASE || '';

// Funzione per mostrare toast (se non esiste gi√†)
function showToast(message, type = 'ok') {
  const toast = document.createElement('div');
  toast.className = `toast toast--${type}`;
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 6px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    background: ${type === 'ok' ? 'var(--success)' : 'var(--danger)'};
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.transform = 'translateX(0)';
  }, 100);
  
  setTimeout(() => {
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// Carica le notifiche dall'API
async function loadNotifications() {
  try {
    console.log('Caricamento notifiche da:', `${basePath}/notifiche/api`);
    const response = await fetch(`${basePath}/notifiche/api`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('Dati ricevuti:', data);
    
    if (data.success) {
      notifications = data.notifiche || [];
      renderNotifications();
      updateNotificationCount(data.nonLette || 0);
      updateActionButtons(data.nonLette || 0, notifications.length);
    } else {
      throw new Error(data.error || 'Errore caricamento');
    }
  } catch (err) {
    console.error('Errore caricamento notifiche:', err);
    document.getElementById('notificationsList').innerHTML = 
      '<div class="empty-notifications"><div class="icon">‚ùå</div><h3>Errore</h3><p>Impossibile caricare le notifiche</p><button class="btn btn-primary" onclick="loadNotifications()">Riprova</button></div>';
  }
}

// Renderizza le notifiche nel DOM
function renderNotifications() {
  const container = document.getElementById('notificationsList');
  
  if (!notifications || notifications.length === 0) {
    container.innerHTML = `
      <div class="empty-notifications">
        <div class="icon">üì≠</div>
        <h3>Nessuna notifica</h3>
        <p>Non hai ricevuto nessuna notifica.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = notifications.map(notification => `
    <div class="notification-item ${!notification.letta ? 'unread' : ''}" 
         data-id="${notification.id}">
      <div class="notification-icon ${getNotificationType(notification.tipo)}">
        ${getNotificationIcon(notification.tipo)}
      </div>
      <div class="notification-content">
        <div class="notification-title">${escapeHtml(notification.titolo)}</div>
        ${notification.messaggio ? `<div class="notification-message">${escapeHtml(notification.messaggio)}</div>` : ''}
        <div class="notification-time">${formatTime(notification.created_at)}</div>
      </div>
      <div class="notification-actions-item">
        <button class="btn-icon btn-delete-notification" data-id="${notification.id}" title="Elimina">
          üóëÔ∏è
        </button>
      </div>
    </div>
  `).join('');
}

// Funzioni helper
function getNotificationType(type) {
  const types = {
    'ferie_create': 'info',
    'ferie_approvata': 'success',
    'ferie_rifiutata': 'error',
    'ferie_approve': 'warning',
    'system': 'info',
    'info': 'info',
    'success': 'success',
    'warning': 'warning',
    'error': 'error'
  };
  return types[type] || 'info';
}

function getNotificationIcon(type) {
  const icons = {
    'ferie_create': 'üìù',
    'ferie_approvata': '‚úÖ',
    'ferie_rifiutata': '‚ùå',
    'ferie_approve': '‚è≥',
    'system': 'üîß',
    'info': '‚ÑπÔ∏è',
    'success': '‚úÖ',
    'warning': '‚ö†Ô∏è',
    'error': '‚ùå'
  };
  return icons[type] || 'üì¢';
}

function formatTime(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Adesso';
  if (diffMins < 60) return `${diffMins} min fa`;
  if (diffHours < 24) return `${diffHours} ore fa`;
  if (diffDays < 7) return `${diffDays} giorni fa`;
  
  return date.toLocaleDateString('it-IT');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Funzioni API
async function markAsRead(id) {
  try {
    console.log('[frontend] Marcatura notifica come letta:', {
      id: id,
      basePath: basePath,
      url: `${basePath}/notifiche/${id}/read`
    });
    
    const notification = notifications.find(n => n.id === id);
    console.log('[frontend] Notifica trovata:', notification ? {
      id: notification.id,
      letta: notification.letta,
      titolo: notification.titolo
    } : 'NON TROVATA');
    
    if (notification && !notification.letta) {
      console.log('[frontend] Invio richiesta POST...');
      const response = await fetch(`${basePath}/notifiche/${id}/read`, { 
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      console.log('[frontend] Risposta HTTP:', {
        status: response.status,
        statusText: response.statusText,
        ok: response.ok
      });
      
      const data = await response.json();
      console.log('[frontend] Risposta JSON:', data);
      
      if (data.success) {
        notification.letta = true;
        renderNotifications();
        updateNotificationCount(data.nonLette);
        updateActionButtons(data.nonLette, notifications.length);
        showToast('Notifica marcata come letta', 'ok');
        console.log('[frontend] Marcatura completata con successo');
      } else {
        console.error('[frontend] Errore nel response:', data);
        showToast(data.error || 'Errore durante la marcatura', 'error');
      }
    } else {
      console.log('[frontend] Notifica gi√† letta o non trovata');
    }
  } catch (err) {
    console.error('[frontend] Errore marcatura notifica:', {
      message: err.message,
      stack: err.stack
    });
    showToast('Errore durante la marcatura della notifica', 'error');
  }
}

async function markAllRead() {
  try {
    const response = await fetch(`${basePath}/notifiche/read-all`, { method: 'POST' });
    const data = await response.json();
    
    if (data.success) {
      notifications.forEach(n => n.letta = true);
      renderNotifications();
      updateNotificationCount(0);
      updateActionButtons(0, notifications.length);
      showToast('Tutte le notifiche sono state marcate come lette', 'ok');
    }
  } catch (err) {
    console.error('Errore marcatura notifiche:', err);
    showToast('Errore durante la marcatura delle notifiche', 'error');
  }
}

async function deleteNotification(id) {
  if (!confirm('Sei sicuro di voler eliminare questa notifica?')) return;
  
  try {
    console.log('Eliminazione notifica:', id);
    const response = await fetch(`${basePath}/notifiche/${id}`, { method: 'DELETE' });
    const data = await response.json();
    console.log('Risposta eliminazione:', data);
    
    if (data.success) {
      notifications = notifications.filter(n => n.id !== id);
      renderNotifications();
      updateNotificationCount(data.nonLette);
      updateActionButtons(data.nonLette, notifications.length);
      showToast('Notifica eliminata', 'ok');
    }
  } catch (err) {
    console.error('Errore eliminazione notifica:', err);
    showToast('Errore durante l\'eliminazione della notifica', 'error');
  }
}

async function deleteAllNotifications() {
  if (!confirm('Sei sicuro di voler eliminare TUTTE le notifiche? Questa azione non √® reversibile.')) return;
  
  try {
    const response = await fetch(`${basePath}/notifiche/delete-all`, { method: 'DELETE' });
    const data = await response.json();
    
    if (data.success) {
      notifications = [];
      renderNotifications();
      updateNotificationCount(0);
      updateActionButtons(0, 0);
      showToast('Tutte le notifiche sono state eliminate', 'ok');
    }
  } catch (err) {
    console.error('Errore eliminazione notifiche:', err);
    showToast('Errore durante l\'eliminazione delle notifiche', 'error');
  }
}

function refreshNotifications() {
  loadNotifications();
}

// Aggiorna il badge delle notifiche nella sidebar
function updateNotificationCount(count) {
  const badge = document.querySelector('.notification-badge');
  if (badge) {
    const newCount = count !== undefined ? count : notifications.filter(n => !n.letta).length;
    if (newCount > 0) {
      badge.textContent = newCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }
}

// Aggiorna i pulsanti di azione in base allo stato
function updateActionButtons(nonLette, totalCount) {
  const markAllBtn = document.querySelector('.btn-mark-all-read');
  const deleteAllBtn = document.querySelector('.btn-delete-all');
  
  if (markAllBtn) {
    if (nonLette > 0) {
      markAllBtn.style.display = 'inline-flex';
      markAllBtn.textContent = `Marca tutte come lette (${nonLette})`;
    } else {
      markAllBtn.style.display = 'none';
    }
  }
  
  if (deleteAllBtn) {
    if (totalCount > 0) {
      deleteAllBtn.style.display = 'inline-flex';
    } else {
      deleteAllBtn.style.display = 'none';
    }
  }
}

// Event delegation per tutti i click
document.addEventListener('click', function(e) {
  // Click su una notifica per marcarla come letta
  const notificationItem = e.target.closest('.notification-item');
  if (notificationItem && !e.target.closest('.btn-delete-notification')) {
    const id = notificationItem.dataset.id;
    if (id) {
      markAsRead(parseInt(id));
    }
  }
  
  // Click sul pulsante elimina singola notifica
  const deleteBtn = e.target.closest('.btn-delete-notification');
  if (deleteBtn) {
    e.stopPropagation();
    const id = deleteBtn.dataset.id;
    if (id) {
      deleteNotification(parseInt(id));
    }
  }
  
  // Click su "Marca tutte come lette"
  const markAllBtn = e.target.closest('.btn-mark-all-read');
  if (markAllBtn) {
    markAllRead();
  }
  
  // Click su "Elimina tutte"
  const deleteAllBtn = e.target.closest('.btn-delete-all');
  if (deleteAllBtn) {
    deleteAllNotifications();
  }
  
  // Click su "Aggiorna"
  const refreshBtn = e.target.closest('.btn-refresh');
  if (refreshBtn) {
    refreshNotifications();
  }
});

// Inizializzazione al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
  loadNotifications();
});
</script>
