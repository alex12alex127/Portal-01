<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
  </svg>
  Gestione Avvisi
</h1>

<p class="text-muted" style="margin-top:-0.5rem;">Crea e gestisci gli avvisi visibili ai dipendenti. Puoi impostare periodo, tipo e in evidenza.</p>

<div class="card">
  <div class="card-header">
    <div class="card-header__row">
      <h2 style="margin:0;">Avvisi (<%= avvisi.length %>)</h2>
      <button type="button" class="btn js-create-avviso">Crea avviso</button>
    </div>

    <div class="filters" role="region" aria-label="Filtri avvisi">
      <div class="filters__row">
        <div class="filters__item">
          <label class="filters__label" for="filterSearch">Cerca</label>
          <input id="filterSearch" class="filters__control" type="text" placeholder="Titolo...">
        </div>
        <div class="filters__item">
          <label class="filters__label" for="filterTipo">Tipo</label>
          <select id="filterTipo" class="filters__control">
            <option value="">Tutti</option>
            <option value="info">Info</option>
            <option value="warning">Attenzione</option>
            <option value="urgent">Urgente</option>
            <option value="success">Successo</option>
          </select>
        </div>
        <div class="filters__item">
          <label class="filters__label" for="filterStato">Stato</label>
          <select id="filterStato" class="filters__control">
            <option value="">Tutti</option>
            <option value="attivo">Attivo</option>
            <option value="programmato">Programmato</option>
            <option value="scaduto">Scaduto</option>
          </select>
        </div>
        <div class="filters__item filters__item--checkbox">
          <label class="filters__label" for="filterEvidenza">In evidenza</label>
          <label class="filters__check">
            <input id="filterEvidenza" type="checkbox">
            Solo in evidenza
          </label>
        </div>
      </div>
      <div class="filters__row filters__row--actions">
        <button type="button" class="btn btn-secondary js-filters-reset">Reset filtri</button>
      </div>
    </div>
  </div>
  
  <% if (avvisi.length === 0) { %>
    <div class="empty">
      <div class="empty-icon">ðŸ“¢</div>
      <h3>Nessun avviso</h3>
      <p>Crea il primo avviso per comunicare con i dipendenti.</p>
      <button type="button" class="btn js-create-avviso">Crea Avviso</button>
    </div>
  <% } else { %>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Titolo</th>
            <th>Tipo</th>
            <th>Periodo</th>
            <th>Stato</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          <% const oggi = new Date().toISOString().split('T')[0]; %>
          <% avvisi.forEach(function(a) { %>
          <% 
            const da = a.visibile_da ? String(a.visibile_da).slice(0, 10) : '';
            const fino = a.visibile_fino ? String(a.visibile_fino).slice(0, 10) : '';
            let stato = 'attivo';
            if (da && da > oggi) stato = 'programmato';
            if (fino && fino < oggi) stato = 'scaduto';
            const periodoLabel = (!da && !fino) ? 'Sempre' : (da ? ('Dal ' + da) : 'Da oggi') + (fino ? (' al ' + fino) : '');
          %>
          <tr data-tipo="<%= a.tipo %>" data-evidenza="<%= a.in_evidenza ? '1' : '0' %>" data-stato="<%= stato %>" data-titolo="<%= (a.titolo || '').toString().toLowerCase() %>">
            <td>
              <strong><%= a.titolo %></strong>
              <% if (a.contenuto && a.contenuto.length > 100) { %>
                <br><small class="text-muted"><%= a.contenuto.substring(0, 100) %>...</small>
              <% } %>
            </td>
            <td>
              <span class="badge badge-<%= a.tipo %>">
                <%= a.tipo === 'info' ? 'Info' : a.tipo === 'warning' ? 'Attenzione' : a.tipo === 'urgent' ? 'Urgente' : a.tipo %>
              </span>
              <% if (a.in_evidenza) { %>
                <span class="badge badge-evidence" title="In evidenza">ðŸ“Œ</span>
              <% } %>
            </td>
            <td>
              <span class="text-muted"><%= periodoLabel %></span>
            </td>
            <td>
              <span class="badge badge-stato badge-stato-<%= stato %>"><%= stato === 'attivo' ? 'Attivo' : stato === 'programmato' ? 'Programmato' : 'Scaduto' %></span>
            </td>
            <td>
              <div class="btn-group">
                <button class="btn btn-sm edit-btn" data-id="<%= a.id %>">Modifica</button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="<%= a.id %>" data-title="<%= a.titolo %>">Elimina</button>
              </div>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  <% } %>
</div>

<!-- Form creazione/modifica -->
<div id="avvisoFormContainer" class="form-overlay" style="display: none;">
  <div class="form-modal">
    <div class="form-header">
      <h2 id="formTitle">Nuovo Avviso</h2>
      <button type="button" class="btn-close js-hide-form">&times;</button>
    </div>
    
    <form id="avvisoForm">
      <input type="hidden" id="avvisoId" name="id">
      
      <div class="form-group">
        <label for="titolo">Titolo *</label>
        <input type="text" id="titolo" name="titolo" required maxlength="255">
      </div>
      
      <div class="form-group">
        <label for="contenuto">Contenuto *</label>
        <textarea id="contenuto" name="contenuto" rows="5" required></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="tipo">Tipo</label>
          <select id="tipo" name="tipo">
            <option value="info">Informazione</option>
            <option value="warning">Attenzione</option>
            <option value="urgent">Urgente</option>
            <option value="success">Successo</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="in_evidenza" name="in_evidenza">
            In evidenza
          </label>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="visibile_da">Visibile dal</label>
          <input type="date" id="visibile_da" name="visibile_da">
        </div>
        
        <div class="form-group">
          <label for="visibile_fino">Visibile fino al</label>
          <input type="date" id="visibile_fino" name="visibile_fino">
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary js-hide-form">Annulla</button>
        <button type="submit" class="btn btn-primary">Salva</button>
      </div>
    </form>
  </div>
</div>

<style>
.admin-actions {
  margin-bottom: 1.5rem;
}

.card-header__row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

.filters {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.filters__row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr;
  gap: 1rem;
}

.filters__row--actions {
  grid-template-columns: 1fr;
  margin-top: 0.75rem;
}

.filters__item--checkbox {
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}

.filters__label {
  display: block;
  font-size: 0.85rem;
  color: var(--muted);
  margin-bottom: 0.35rem;
}

.filters__control {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--surface);
  color: var(--text);
}

.filters__check {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  color: var(--text);
  font-size: 0.9rem;
}

.table-responsive {
  overflow-x: auto;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th,
.table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
}

.table th {
  background: var(--surface);
  font-weight: 600;
  color: var(--text);
}

.btn-group {
  display: flex;
  gap: 0.5rem;
}

.form-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.form-modal {
  background: var(--card-bg);
  border-radius: var(--radius);
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.btn-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
}

.form-modal form {
  padding: 1.5rem;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: var(--text);
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--surface);
  color: var(--text);
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
}

.badge-info { background: #3b82f6; color: white; }
.badge-warning { background: #f59e0b; color: white; }
.badge-urgent { background: #ef4444; color: white; }
.badge-success { background: #10b981; color: white; }
.badge-evidence { background: #ff6b35; color: white; }

.badge-stato { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
.badge-stato-attivo { border-color: #10b981; }
.badge-stato-programmato { border-color: #3b82f6; }
.badge-stato-scaduto { border-color: #ef4444; }

@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .btn-group {
    flex-direction: column;
  }

  .filters__row {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
let editingId = null;

// Assicurati che il DOM sia caricato
document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('click', function(e) {
    const createBtn = e.target.closest('.js-create-avviso');
    if (createBtn) {
      e.preventDefault();
      showCreateForm();
      return;
    }

    const hideBtn = e.target.closest('.js-hide-form');
    if (hideBtn) {
      e.preventDefault();
      hideForm();
      return;
    }
  });

  const searchEl = document.getElementById('filterSearch');
  const tipoEl = document.getElementById('filterTipo');
  const statoEl = document.getElementById('filterStato');
  const evidenzaEl = document.getElementById('filterEvidenza');
  const resetEl = document.querySelector('.js-filters-reset');

  function applyFilters() {
    const q = (searchEl && searchEl.value ? searchEl.value : '').toString().toLowerCase().trim();
    const tipo = tipoEl ? tipoEl.value : '';
    const stato = statoEl ? statoEl.value : '';
    const onlyEvidenza = evidenzaEl ? evidenzaEl.checked : false;

    document.querySelectorAll('tbody tr[data-titolo]').forEach(function(row) {
      const rowTitolo = row.getAttribute('data-titolo') || '';
      const rowTipo = row.getAttribute('data-tipo') || '';
      const rowStato = row.getAttribute('data-stato') || '';
      const rowEvidenza = row.getAttribute('data-evidenza') === '1';

      let ok = true;
      if (q && rowTitolo.indexOf(q) === -1) ok = false;
      if (tipo && rowTipo !== tipo) ok = false;
      if (stato && rowStato !== stato) ok = false;
      if (onlyEvidenza && !rowEvidenza) ok = false;

      row.style.display = ok ? '' : 'none';
    });
  }

  [searchEl, tipoEl, statoEl, evidenzaEl].forEach(function(el) {
    if (!el) return;
    el.addEventListener('input', applyFilters);
    el.addEventListener('change', applyFilters);
  });

  if (resetEl) {
    resetEl.addEventListener('click', function() {
      if (searchEl) searchEl.value = '';
      if (tipoEl) tipoEl.value = '';
      if (statoEl) statoEl.value = '';
      if (evidenzaEl) evidenzaEl.checked = false;
      applyFilters();
    });
  }

  applyFilters();
  
  // Bottoni modifica
  document.querySelectorAll('.edit-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      editAvviso(this.dataset.id);
    });
  });
  
  // Bottoni elimina
  document.querySelectorAll('.delete-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      deleteAvviso(this.dataset.id, this.dataset.title);
    });
  });
});

function showCreateForm() {
  // Verifica che gli elementi esistano
  const formTitle = document.getElementById('formTitle');
  const avvisoForm = document.getElementById('avvisoForm');
  const formContainer = document.getElementById('avvisoFormContainer');
  
  if (!formTitle || !avvisoForm || !formContainer) {
    console.error('Elementi del form non trovati:', { formTitle, avvisoForm, formContainer });
    alert('Errore: form non trovato');
    return;
  }
  
  editingId = null;
  formTitle.textContent = 'Nuovo Avviso';
  avvisoForm.reset();
  formContainer.style.display = 'flex';
}

function hideForm() {
  document.getElementById('avvisoFormContainer').style.display = 'none';
  document.getElementById('avvisoForm').reset();
  editingId = null;
}

function editAvviso(id) {
  editingId = id;
  document.getElementById('formTitle').textContent = 'Modifica Avviso';
  
  fetch('<%= basePath %>/admin/avvisi/' + id)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const avviso = data.avviso;
        document.getElementById('titolo').value = avviso.titolo;
        document.getElementById('contenuto').value = avviso.contenuto;
        document.getElementById('tipo').value = avviso.tipo;
        document.getElementById('in_evidenza').checked = avviso.in_evidenza;
        document.getElementById('visibile_da').value = avviso.visibile_da || '';
        document.getElementById('visibile_fino').value = avviso.visibile_fino || '';
        document.getElementById('avvisoFormContainer').style.display = 'flex';
      } else {
        alert(data.error || 'Errore caricamento avviso');
      }
    })
    .catch(err => {
      console.error('Errore:', err);
      alert('Errore durante il caricamento');
    });
}

function deleteAvviso(id, titolo) {
  if (confirm('Eliminare l avviso: ' + titolo + '?')) {
    fetch('<%= basePath %>/admin/avvisi/' + id, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '<%= csrfToken %>'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || 'Errore eliminazione');
      }
    })
    .catch(err => {
      console.error('Errore:', err);
      alert('Errore durante l eliminazione');
    });
  }
}

// Gestione submit form
document.getElementById('avvisoForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());
  data._csrf = '<%= csrfToken %>';
  
  const url = editingId ? 
    '<%= basePath %>/admin/avvisi/' + editingId : 
    '<%= basePath %>/admin/avvisi';
  const method = editingId ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      hideForm();
      location.reload();
    } else {
      alert(data.error || 'Errore salvataggio');
    }
  })
  .catch(err => {
    console.error('Errore:', err);
    alert('Errore durante il salvataggio');
  });
});

// Chiudi form cliccando fuori
document.getElementById('avvisoFormContainer').addEventListener('click', function(e) {
  if (e.target === this) {
    hideForm();
  }
});
</script>
