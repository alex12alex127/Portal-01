<div class="auth-box">
  <h1><svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.862-.228-1.614-.686-2.031-1.261a6.003 6.003 0 01-3.27-5.687 6 6 0 0112 0c0 .921-.224 1.786-.627 2.575a6.003 6.003 0 01-3.27 5.687" /></svg> Portal-01</h1>
  <h2>Nuova password</h2>
  <% if (!token) { %>
  <p class="message-error">Link non valido o mancante. Richiedi un nuovo link da <a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/auth/forgot-password">Password dimenticata</a>.</p>
  <% } else { %>
  <form id="resetForm">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="hidden" name="token" value="<%= token %>">
    <label for="reset-password">Nuova password</label>
    <input id="reset-password" type="password" name="new_password" placeholder="Almeno 8 caratteri, maiuscole, minuscole, numeri" required minlength="8">
    <label for="reset-confirm">Conferma password</label>
    <input id="reset-confirm" type="password" name="confirm_password" placeholder="Ripeti la password" required>
    <button type="submit" class="btn"><span class="btn-text">Imposta password</span></button>
  </form>
  <script>
    (function(){ var base='<%= typeof basePath !== "undefined" ? basePath : "" %>';
    document.getElementById('resetForm').onsubmit=async function(e){
      e.preventDefault();
      var btn=this.querySelector('button'), txt=btn.querySelector('.btn-text'), msg=document.getElementById('msg')||document.createElement('div');
      if(!msg.id){ msg.id='msg'; msg.setAttribute('role','status'); this.parentNode.appendChild(msg); }
      msg.textContent=''; msg.className=''; msg.removeAttribute('class');
      btn.disabled=true; if(txt) txt.textContent='Salvataggio...';
      try{
        var r=await fetch(base+'/auth/reset-password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.fromEntries(new FormData(this)))});
        var j; try{j=await r.json();}catch(_){j={};}
        if(j.success){ msg.textContent=j.message||'Password aggiornata.'; msg.className='message-ok'; if(j.redirect) setTimeout(function(){ location.href=j.redirect; },1500); }
        else{ msg.textContent=j.error||'Errore'; msg.className='message-error'; }
      }catch(x){ msg.textContent='Errore di connessione'; msg.className='message-error'; }
      btn.disabled=false; if(txt) txt.textContent='Imposta password';
    }; })();
  </script>
  <% } %>
  <p><a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/auth/login">Torna al login</a></p>
  <div id="msg" role="status" aria-live="polite"></div>
</div>
