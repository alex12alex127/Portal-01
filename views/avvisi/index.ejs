<% var bp = typeof basePath !== 'undefined' ? basePath : ''; %>
<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
  Avvisi
  <% if (nonLetti > 0) { %><span class="badge badge--alert" style="font-size:.85rem;margin-left:.5rem"><%= nonLetti %> da leggere</span><% } %>
</h1>

<% if (avvisi.length === 0) { %>
  <div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:3rem;text-align:center">
    <svg style="width:48px;height:48px;color:var(--muted);opacity:.4;margin-bottom:.75rem" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
    <p style="margin:0;color:var(--muted);font-size:.95rem">Nessun avviso disponibile al momento.</p>
  </div>
<% } else { %>
  <div style="display:flex;flex-direction:column;gap:1rem">
    <% avvisi.forEach(function(a) { %>
    <div class="avviso-card" data-id="<%= a.id %>" style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;overflow:hidden;transition:all .2s;<%= a.in_evidenza ? 'border-left:4px solid var(--primary,#4f46e5)' : '' %>;<%= a.letto ? 'opacity:.7' : '' %>">
      <div style="padding:1.25rem">
        <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin-bottom:.75rem">
          <span class="badge badge--avviso badge--<%= a.tipo %>" style="font-size:.7rem"><%= a.tipo === 'info' ? 'Info' : a.tipo === 'warning' ? 'Attenzione' : a.tipo === 'urgent' ? 'Urgente' : a.tipo === 'success' ? 'Successo' : a.tipo %></span>
          <% if (a.in_evidenza) { %><span style="background:var(--primary,#4f46e5);color:#fff;padding:.1rem .5rem;border-radius:999px;font-size:.7rem;font-weight:600">In evidenza</span><% } %>
          <% if (!a.letto) { %><span style="width:8px;height:8px;border-radius:50%;background:var(--primary,#4f46e5);flex-shrink:0" title="Non letto"></span><% } %>
          <span style="margin-left:auto;font-size:.8rem;color:var(--muted)"><%= a.created_at ? new Date(a.created_at).toLocaleDateString('it-IT') : '' %></span>
        </div>
        <a href="<%= bp %>/avvisi/<%= a.id %>" style="display:block;font-size:1.15rem;font-weight:600;color:var(--text);text-decoration:none;margin-bottom:.5rem"><%= a.titolo %></a>
        <% if (a.contenuto) { %>
          <p style="color:var(--muted);margin:0 0 .75rem;line-height:1.6;font-size:.9rem;white-space:pre-wrap;word-break:break-word"><%= a.contenuto.length > 200 ? a.contenuto.substring(0, 200) + '...' : a.contenuto %></p>
        <% } %>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;padding-top:.75rem;border-top:1px solid var(--border,#f3f4f6)">
          <% if (a.autore_nome) { %>
          <div style="display:flex;align-items:center;gap:.5rem">
            <div style="width:24px;height:24px;border-radius:50%;background:var(--primary,#4f46e5);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700"><%= a.autore_nome.charAt(0).toUpperCase() %></div>
            <span style="font-size:.8rem;color:var(--muted)"><%= a.autore_nome %></span>
          </div>
          <% } else { %><span></span><% } %>
          <% if (!a.letto) { %>
            <button type="button" class="btn btn-sm btn-mark-read" data-id="<%= a.id %>" style="font-size:.78rem">Segna come letto</button>
          <% } else { %>
            <span style="font-size:.78rem;color:var(--muted);display:flex;align-items:center;gap:.3rem">
              <svg style="width:14px;height:14px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
              Letto
            </span>
          <% } %>
        </div>
      </div>
    </div>
    <% }); %>
  </div>
<% } %>

<style>
.avviso-card:hover { box-shadow:0 4px 16px rgba(0,0,0,.08); transform:translateY(-1px); }
</style>

<script>
(function(){
  var base = window.APP_BASE || '';
  var csrf = '<%= csrfToken %>';
  function showMsg(txt, ok) {
    var el = document.createElement('div');
    el.textContent = txt;
    el.style.cssText = 'position:fixed;top:1rem;right:1rem;padding:.75rem 1.25rem;border-radius:var(--radius);color:#fff;font-weight:500;z-index:9999;background:' + (ok ? 'var(--success,#22c55e)' : 'var(--danger,#ef4444)');
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }

  document.addEventListener('click', async function(e) {
    var btn = e.target.closest('.btn-mark-read');
    if (!btn) return;
    var id = btn.dataset.id;
    try {
      var r = await fetch(base + '/avvisi/' + id + '/letta', { method:'POST', headers:{'Content-Type':'application/json', 'X-CSRF-Token': csrf} });
      var data = await r.json();
      if (data.success) {
        var card = document.querySelector('.avviso-card[data-id="' + id + '"]');
        if (card) { card.classList.add('avviso-card--letto'); }
        btn.replaceWith(Object.assign(document.createElement('span'), { className:'text-muted', style:'font-size:.85rem', textContent:'Letto' }));
        showMsg('Avviso segnato come letto', true);
      } else { showMsg(data.error || 'Errore', false); }
    } catch(err) { showMsg('Errore di rete', false); }
  });
})();
</script>
