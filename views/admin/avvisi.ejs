<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
  Gestione Avvisi
  <span style="font-size:.9rem;font-weight:400;color:var(--muted);margin-left:.5rem">(<%= avvisi.length %>)</span>
</h1>

<div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;overflow:hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid var(--border,#e5e7eb)">
    <span style="font-size:.9rem;color:var(--muted)"><%= avvisi.length %> avvisi totali</span>
    <button type="button" class="btn btn-sm" id="btnNewAvviso" style="display:inline-flex;align-items:center;gap:.3rem">
      <svg style="width:14px;height:14px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
      Nuovo avviso
    </button>
  </div>

  <% if (avvisi.length === 0) { %>
    <div style="padding:3rem;text-align:center">
      <svg style="width:48px;height:48px;color:var(--muted);opacity:.4;margin-bottom:.75rem" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
      <p style="margin:0;color:var(--muted);font-size:.95rem">Nessun avviso.</p>
    </div>
  <% } else { %>
    <div>
      <% avvisi.forEach(function(a) { %>
      <div data-id="<%= a.id %>" class="rsp-list-row" style="display:flex;align-items:center;gap:1rem;padding:.85rem 1.25rem;border-bottom:1px solid var(--border,#f3f4f6)">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin-bottom:.25rem">
            <span style="font-weight:600;font-size:.95rem"><%= a.titolo %></span>
            <span class="badge badge--avviso badge--<%= a.tipo %>" style="font-size:.65rem"><%= a.tipo === 'info' ? 'Info' : a.tipo === 'warning' ? 'Attenzione' : a.tipo === 'urgent' ? 'Urgente' : a.tipo === 'success' ? 'Successo' : a.tipo %></span>
            <% if (a.in_evidenza) { %><span style="background:var(--primary,#1a56db);color:#fff;padding:.05rem .4rem;border-radius:999px;font-size:.65rem;font-weight:600">In evidenza</span><% } %>
          </div>
          <% if (a.contenuto && a.contenuto.length > 80) { %>
          <div style="font-size:.82rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:.2rem"><%= a.contenuto.substring(0, 80) %>...</div>
          <% } %>
          <div style="font-size:.75rem;color:var(--muted);display:flex;gap:.75rem">
            <span><%= a.created_at ? new Date(a.created_at).toLocaleDateString('it-IT') : '' %></span>
            <% if (!a.visibile_da && !a.visibile_fino) { %>
              <span>Sempre visibile</span>
            <% } else { %>
              <span><%= a.visibile_da ? 'Dal ' + new Date(a.visibile_da).toLocaleDateString('it-IT') : '' %> <%= a.visibile_fino ? 'al ' + new Date(a.visibile_fino).toLocaleDateString('it-IT') : '' %></span>
            <% } %>
          </div>
        </div>
        <div style="display:flex;gap:.35rem;flex-shrink:0">
          <button type="button" class="btn-edit" data-id="<%= a.id %>" title="Modifica" style="width:30px;height:30px;border-radius:50%;border:1px solid var(--border,#ddd);background:var(--card-bg,#fff);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--primary,#1a56db);transition:all .15s">
            <svg style="width:14px;height:14px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125" /></svg>
          </button>
          <button type="button" class="btn-del" data-id="<%= a.id %>" data-titolo="<%= a.titolo %>" title="Elimina" style="width:30px;height:30px;border-radius:50%;border:1px solid var(--border,#ddd);background:var(--card-bg,#fff);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--danger,#ef4444);transition:all .15s">
            <svg style="width:14px;height:14px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
          </button>
        </div>
      </div>
      <% }); %>
    </div>
  <% } %>
</div>

<style>
.btn-edit:hover { background:var(--primary,#1a56db) !important; color:#fff !important; border-color:var(--primary,#1a56db) !important }
.btn-del:hover { background:var(--danger,#ef4444) !important; color:#fff !important; border-color:var(--danger,#ef4444) !important }
</style>

<!-- Modale -->
<div id="avvisoModal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border-radius:var(--radius-lg,12px);width:90%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 40px rgba(0,0,0,.15)">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:1.25rem;border-bottom:1px solid var(--border)">
      <h3 id="modalTitle" style="margin:0">Nuovo Avviso</h3>
      <button type="button" id="modalClose" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--muted);padding:0;line-height:1">&times;</button>
    </div>
    <form id="avvisoForm" style="padding:1.25rem">
      <input type="hidden" id="fId" value="">
      <div style="margin-bottom:1rem">
        <label for="fTitolo">Titolo *</label>
        <input type="text" id="fTitolo" name="titolo" required maxlength="255" style="width:100%">
      </div>
      <div style="margin-bottom:1rem">
        <label for="fContenuto">Contenuto *</label>
        <textarea id="fContenuto" name="contenuto" rows="4" required style="width:100%"></textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
        <div>
          <label for="fTipo">Tipo</label>
          <select id="fTipo" name="tipo" style="width:100%">
            <option value="info">Info</option>
            <option value="warning">Attenzione</option>
            <option value="urgent">Urgente</option>
            <option value="success">Successo</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
            <input type="checkbox" id="fEvidenza" name="in_evidenza">
            <span>In evidenza</span>
          </label>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">
        <div>
          <label for="fVisibileDa">Visibile dal</label>
          <input type="date" id="fVisibileDa" name="visibile_da" style="width:100%">
        </div>
        <div>
          <label for="fVisibileFino">Visibile fino al</label>
          <input type="date" id="fVisibileFino" name="visibile_fino" style="width:100%">
        </div>
      </div>
      <p class="text-muted" style="font-size:.85rem;margin-bottom:1rem">Se lasci vuoto le date, l'avviso Ã¨ sempre visibile.</p>
      <div style="display:flex;justify-content:flex-end;gap:.5rem;padding-top:1rem;border-top:1px solid var(--border)">
        <button type="button" class="btn btn-sm" id="modalCancel">Annulla</button>
        <button type="submit" class="btn btn-sm btn--primary" id="modalSave">Salva</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  var base = window.APP_BASE || '';
  var csrf = '<%= csrfToken %>';
  var modal = document.getElementById('avvisoModal');
  var form = document.getElementById('avvisoForm');

  function showMsg(txt, ok) {
    var el = document.createElement('div');
    el.textContent = txt;
    el.style.cssText = 'position:fixed;top:1rem;right:1rem;padding:.75rem 1.25rem;border-radius:var(--radius);color:#fff;font-weight:500;z-index:9999;background:' + (ok ? 'var(--success,#22c55e)' : 'var(--danger,#ef4444)');
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }

  function openModal(title) {
    document.getElementById('modalTitle').textContent = title || 'Nuovo Avviso';
    modal.style.display = 'block';
  }

  function closeModal() {
    modal.style.display = 'none';
    form.reset();
    document.getElementById('fId').value = '';
  }

  // Nuovo avviso
  document.getElementById('btnNewAvviso').addEventListener('click', function() {
    form.reset();
    document.getElementById('fId').value = '';
    openModal('Nuovo Avviso');
  });

  // Chiudi modale
  document.getElementById('modalClose').addEventListener('click', closeModal);
  document.getElementById('modalCancel').addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });

  // Submit form
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    var id = document.getElementById('fId').value;
    var body = {
      titolo: document.getElementById('fTitolo').value,
      contenuto: document.getElementById('fContenuto').value,
      tipo: document.getElementById('fTipo').value,
      in_evidenza: document.getElementById('fEvidenza').checked ? '1' : '',
      visibile_da: document.getElementById('fVisibileDa').value || '',
      visibile_fino: document.getElementById('fVisibileFino').value || ''
    };
    try {
      var url = id ? base + '/admin/avvisi/' + id : base + '/admin/avvisi';
      var method = id ? 'PUT' : 'POST';
      var r = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf }, body: JSON.stringify(body) });
      var data = await r.json();
      if (data.success) {
        showMsg(id ? 'Avviso aggiornato' : 'Avviso creato', true);
        closeModal();
        location.reload();
      } else { showMsg(data.error || 'Errore', false); }
    } catch(err) { showMsg('Errore di rete', false); }
  });

  // Event delegation per modifica e elimina
  document.addEventListener('click', async function(e) {
    // Modifica
    var editBtn = e.target.closest('.btn-edit');
    if (editBtn) {
      var id = editBtn.dataset.id;
      try {
        var r = await fetch(base + '/admin/avvisi/' + id);
        var data = await r.json();
        if (data.success && data.avviso) {
          var a = data.avviso;
          document.getElementById('fId').value = a.id;
          document.getElementById('fTitolo').value = a.titolo;
          document.getElementById('fContenuto').value = a.contenuto;
          document.getElementById('fTipo').value = a.tipo || 'info';
          document.getElementById('fEvidenza').checked = !!a.in_evidenza;
          document.getElementById('fVisibileDa').value = a.visibile_da || '';
          document.getElementById('fVisibileFino').value = a.visibile_fino || '';
          openModal('Modifica Avviso');
        } else { showMsg(data.error || 'Errore caricamento', false); }
      } catch(err) { showMsg('Errore di rete', false); }
    }

    // Elimina
    var delBtn = e.target.closest('.btn-del');
    if (delBtn) {
      var id = delBtn.dataset.id;
      var titolo = delBtn.dataset.titolo;
      if (!confirm('Eliminare "' + titolo + '"?')) return;
      try {
        var r = await fetch(base + '/admin/avvisi/' + id, { method: 'DELETE', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf } });
        var data = await r.json();
        if (data.success) {
          showMsg('Avviso eliminato', true);
          var row = document.querySelector('tr[data-id="' + id + '"]');
          if (row) row.remove();
        } else { showMsg(data.error || 'Errore', false); }
      } catch(err) { showMsg('Errore di rete', false); }
    }
  });
})();
</script>
