<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ferie - Portal-01</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="app-wrap">
    <%- include('../partials/sidebar', { user: user, activePage: 'ferie' }) %>
    <main class="main">
      <div class="container">
        <h1>Gestione Ferie</h1>
        <div class="card">
          <h2>Nuova richiesta</h2>
          <form id="frm">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <label>Data inizio <input type="date" name="data_inizio" required></label>
            <label>Data fine <input type="date" name="data_fine" required></label>
            <label>Tipo <select name="tipo"><option value="ferie">Ferie</option><option value="permesso">Permesso</option><option value="malattia">Malattia</option></select></label>
            <label>Note <textarea name="note" rows="2"></textarea></label>
            <button type="submit" class="btn">Invia</button>
          </form>
          <div id="ferieMsg"></div>
        </div>
        <div class="card">
          <h2>Le mie richieste</h2>
          <% if (ferie.length === 0) { %>
            <p class="empty">Nessuna richiesta. Usa il modulo sopra.</p>
          <% } else { %>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Da</th><th>A</th><th>Giorni</th><th>Tipo</th><th>Stato</th></tr></thead>
                <tbody>
                  <% ferie.forEach(function(f) { %>
                  <tr>
                    <td><%= f.data_inizio %></td>
                    <td><%= f.data_fine %></td>
                    <td><%= f.giorni_totali %></td>
                    <td><%= f.tipo %></td>
                    <td><span class="badge <%= f.stato %>"><%= f.stato %></span></td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
    </main>
  </div>
  <script>
    document.getElementById('frm').onsubmit=async function(e){
      e.preventDefault();
      var btn=this.querySelector('button'),msg=document.getElementById('ferieMsg');
      msg.textContent='';btn.disabled=true;
      try{
        var r=await fetch('/ferie/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.fromEntries(new FormData(this)))});
        var j=await r.json();
        if(j.success)location.reload();else msg.textContent=j.error||'Errore';
      }catch(x){msg.textContent='Errore';}
      btn.disabled=false;
    };
  </script>
</body>
</html>
