<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
  Notifiche
  <% if (nonLette > 0) { %><span class="badge badge--alert" style="font-size:.85rem;margin-left:.5rem"><%= nonLette %> nuove</span><% } %>
</h1>

<div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;overflow:hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid var(--border,#e5e7eb)">
    <span style="font-size:.9rem;color:var(--muted)"><%= notifiche.length %> notifiche totali</span>
    <div style="display:flex;gap:.5rem">
      <% if (nonLette > 0) { %>
        <button type="button" class="btn btn-sm" id="btnMarkAllRead" style="font-size:.78rem">Segna tutte lette</button>
      <% } %>
      <% if (notifiche.length > 0) { %>
        <button type="button" class="btn btn-sm btn--danger" id="btnDeleteAll" style="font-size:.78rem">Elimina tutte</button>
      <% } %>
    </div>
  </div>

  <% if (notifiche.length === 0) { %>
    <div style="padding:3rem;text-align:center">
      <svg style="width:48px;height:48px;color:var(--muted);opacity:.4;margin-bottom:.75rem" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
      <p style="margin:0;color:var(--muted);font-size:.95rem">Nessuna notifica.</p>
    </div>
  <% } else { %>
    <div id="notificheList">
      <% notifiche.forEach(function(n) { %>
      <div class="notifiche-item <%= n.letta ? 'letta' : 'non-letta' %>" data-id="<%= n.id %>" style="display:flex;align-items:flex-start;gap:1rem;padding:1rem 1.25rem;border-bottom:1px solid var(--border,#f3f4f6);transition:all .3s;<%= !n.letta ? 'border-left:3px solid var(--primary,#4f46e5);background:rgba(79,70,229,.03)' : '' %>">
        <div style="width:36px;height:36px;border-radius:50%;background:<%= !n.letta ? 'var(--primary,#4f46e5)' : 'var(--border,#e5e7eb)' %>;color:<%= !n.letta ? '#fff' : 'var(--muted)' %>;display:flex;align-items:center;justify-content:center;flex-shrink:0">
          <svg style="width:16px;height:16px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:<%= !n.letta ? '600' : '400' %>;font-size:.9rem;margin-bottom:.15rem"><%= n.titolo || 'Notifica' %></div>
          <% if (n.messaggio) { %><div style="font-size:.85rem;color:var(--muted);white-space:pre-wrap;word-break:break-word;margin-bottom:.25rem"><%= n.messaggio %></div><% } %>
          <div style="font-size:.75rem;color:var(--muted)"><%= n.created_at ? new Date(n.created_at).toLocaleString('it-IT') : '' %></div>
        </div>
        <div style="display:flex;gap:.3rem;flex-shrink:0;align-items:center">
          <% if (!n.letta) { %>
            <button type="button" class="btn-mark-read" data-id="<%= n.id %>" title="Marca come letta" style="width:30px;height:30px;border-radius:50%;border:1px solid var(--border,#ddd);background:var(--card-bg,#fff);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;color:var(--success,#22c55e)">
              <svg style="width:14px;height:14px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
            </button>
          <% } %>
          <button type="button" class="btn-delete" data-id="<%= n.id %>" title="Elimina" style="width:30px;height:30px;border-radius:50%;border:1px solid var(--border,#ddd);background:var(--card-bg,#fff);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;color:var(--danger,#ef4444)">
            <svg style="width:14px;height:14px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
      </div>
      <% }); %>
    </div>
  <% } %>
</div>

<style>
.notifiche-item.removing { opacity:0; transform:translateX(30px); transition:all .3s }
.notifiche-item.letta { opacity:.65 }
.btn-mark-read:hover { background:var(--success,#22c55e) !important; color:#fff !important; border-color:var(--success,#22c55e) !important }
.btn-delete:hover { background:var(--danger,#ef4444) !important; color:#fff !important; border-color:var(--danger,#ef4444) !important }
</style>

<script>
(function(){
  var base = window.APP_BASE || '';
  var csrf = '<%= csrfToken %>';

  function showMsg(txt, ok) {
    var el = document.createElement('div');
    el.className = 'toast-msg ' + (ok ? 'toast--ok' : 'toast--err');
    el.textContent = txt;
    el.style.cssText = 'position:fixed;top:1rem;right:1rem;padding:.75rem 1.25rem;border-radius:var(--radius);color:#fff;font-weight:500;z-index:9999;background:' + (ok ? 'var(--success,#22c55e)' : 'var(--danger,#ef4444)');
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }

  async function api(url, method) {
    var r = await fetch(base + url, { method: method || 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrf } });
    return await r.json();
  }

  document.addEventListener('click', async function(e) {
    // Marca singola come letta
    var markBtn = e.target.closest('.btn-mark-read');
    if (markBtn) {
      var id = markBtn.dataset.id;
      try {
        var res = await api('/notifiche/' + id + '/read', 'POST');
        if (res.success) {
          var item = document.querySelector('.notifiche-item[data-id="' + id + '"]');
          if (item) { item.classList.remove('non-letta'); item.classList.add('letta'); }
          markBtn.remove();
          showMsg('Notifica marcata come letta', true);
          updateBadge(res.nonLette);
        } else { showMsg(res.error || 'Errore', false); }
      } catch(err) { showMsg('Errore di rete', false); }
    }

    // Elimina singola
    var delBtn = e.target.closest('.btn-delete');
    if (delBtn) {
      var id = delBtn.dataset.id;
      if (!confirm('Eliminare questa notifica?')) return;
      try {
        var res = await api('/notifiche/' + id, 'DELETE');
        if (res.success) {
          var item = document.querySelector('.notifiche-item[data-id="' + id + '"]');
          if (item) { item.classList.add('removing'); setTimeout(function(){ item.remove(); checkEmpty(); }, 300); }
          showMsg('Notifica eliminata', true);
          updateBadge(res.nonLette);
        } else { showMsg(res.error || 'Errore', false); }
      } catch(err) { showMsg('Errore di rete', false); }
    }
  });

  // Marca tutte come lette
  var btnAll = document.getElementById('btnMarkAllRead');
  if (btnAll) btnAll.addEventListener('click', async function() {
    try {
      var res = await api('/notifiche/read-all', 'POST');
      if (res.success) {
        document.querySelectorAll('.notifiche-item.non-letta').forEach(function(el) {
          el.classList.remove('non-letta'); el.classList.add('letta');
        });
        document.querySelectorAll('.btn-mark-read').forEach(function(b) { b.remove(); });
        btnAll.style.display = 'none';
        showMsg('Tutte le notifiche marcate come lette (' + (res.updatedCount || 0) + ')', true);
        updateBadge(0);
      } else { showMsg(res.error || 'Errore', false); }
    } catch(err) { showMsg('Errore di rete', false); }
  });

  // Elimina tutte
  var btnDelAll = document.getElementById('btnDeleteAll');
  if (btnDelAll) btnDelAll.addEventListener('click', async function() {
    if (!confirm('Eliminare TUTTE le notifiche?')) return;
    try {
      var res = await api('/notifiche/delete-all', 'DELETE');
      if (res.success) {
        var list = document.getElementById('notificheList');
        if (list) list.innerHTML = '';
        btnDelAll.style.display = 'none';
        if (btnAll) btnAll.style.display = 'none';
        checkEmpty();
        showMsg('Tutte le notifiche eliminate (' + (res.deletedCount || 0) + ')', true);
        updateBadge(0);
      } else { showMsg(res.error || 'Errore', false); }
    } catch(err) { showMsg('Errore di rete', false); }
  });

  function updateBadge(count) {
    var b = document.querySelector('.sidebar .notification-badge');
    if (b) { if (count > 0) { b.textContent = count; b.style.display = ''; } else { b.style.display = 'none'; } }
  }

  function checkEmpty() {
    var list = document.getElementById('notificheList');
    if (list && list.children.length === 0) {
      list.outerHTML = '<p class="empty">Nessuna notifica.</p>';
    }
  }
})();
</script>
