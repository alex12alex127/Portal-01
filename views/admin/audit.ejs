<% var bp = typeof basePath !== 'undefined' ? basePath : ''; %>
<h1 class="page-title">
  <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
  Audit Log
  <span style="font-size:.9rem;font-weight:400;color:var(--muted);margin-left:.5rem">(<%= pagination.total %>)</span>
</h1>

<div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;overflow:hidden;margin-bottom:1rem">
  <form method="get" action="<%= bp %>/admin/audit" class="rsp-flex-form" style="display:flex;gap:.75rem;align-items:flex-end;flex-wrap:wrap;padding:1rem 1.25rem">
    <div style="min-width:140px">
      <label style="display:block;font-size:.8rem;font-weight:600;color:var(--muted);margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.03em">Utente</label>
      <select name="user_id" style="width:100%">
        <option value="">Tutti</option>
        <% (usersList || []).forEach(function(u) { %>
        <option value="<%= u.id %>"<%= filtri.user_id == u.id ? ' selected' : '' %>><%= u.username %></option>
        <% }); %>
      </select>
    </div>
    <div style="flex:1;min-width:160px">
      <label style="display:block;font-size:.8rem;font-weight:600;color:var(--muted);margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.03em">Azione</label>
      <input type="text" name="azione" placeholder="es. login, ferie_approvata" value="<%= filtri.azione || '' %>" style="width:100%">
    </div>
    <div style="min-width:140px">
      <label style="display:block;font-size:.8rem;font-weight:600;color:var(--muted);margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.03em">Data</label>
      <input type="date" name="data" value="<%= filtri.data || '' %>" style="width:100%">
    </div>
    <button type="submit" class="btn btn-sm">Filtra</button>
    <% if (filtri.user_id || filtri.azione || filtri.data) { %>
    <a href="<%= bp %>/admin/audit" class="btn btn-sm btn--secondary">Reset</a>
    <% } %>
  </form>
</div>

<div style="background:var(--card-bg,#fff);border:1px solid var(--border,#e5e7eb);border-radius:12px;overflow:hidden">
  <% if (logs.length === 0) { %>
    <div style="padding:3rem;text-align:center">
      <svg style="width:48px;height:48px;color:var(--muted);opacity:.4;margin-bottom:.75rem" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
      <p style="margin:0;color:var(--muted);font-size:.95rem">Nessun evento nel log.</p>
    </div>
  <% } else { %>
    <div>
      <% logs.forEach(function(l) { %>
      <div class="rsp-list-row" style="display:flex;align-items:center;gap:1rem;padding:.75rem 1.25rem;border-bottom:1px solid var(--border,#f3f4f6)">
        <div style="width:36px;height:36px;border-radius:50%;background:var(--primary-light,#eef2ff);color:var(--primary,#1a56db);display:flex;align-items:center;justify-content:center;flex-shrink:0">
          <svg style="width:16px;height:16px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        </div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
            <span style="font-weight:600;font-size:.9rem"><%= l.full_name || l.username || 'â€”' %></span>
            <span class="badge badge--avviso badge--info" style="font-size:.7rem"><%= l.azione %></span>
          </div>
          <div style="font-size:.75rem;color:var(--muted);margin-top:.1rem"><%= l.created_at ? new Date(l.created_at).toLocaleString('it-IT') : '' %></div>
        </div>
      </div>
      <% }); %>
    </div>

    <% if (pagination.totalPages > 1) { %>
    <div style="display:flex;justify-content:space-between;align-items:center;padding:.75rem 1.25rem;border-top:1px solid var(--border,#e5e7eb);background:var(--bg-subtle,#f9fafb)">
      <span style="font-size:.85rem;color:var(--muted)">Pagina <%= pagination.page %> di <%= pagination.totalPages %></span>
      <div style="display:flex;gap:.5rem">
        <% if (pagination.page > 1) { %><a href="?page=<%= pagination.page - 1 %>&limit=<%= pagination.limit %>&user_id=<%= filtri.user_id || '' %>&azione=<%= filtri.azione || '' %>&data=<%= filtri.data || '' %>" class="btn btn-sm">Precedente</a><% } %>
        <% if (pagination.page < pagination.totalPages) { %><a href="?page=<%= pagination.page + 1 %>&limit=<%= pagination.limit %>&user_id=<%= filtri.user_id || '' %>&azione=<%= filtri.azione || '' %>&data=<%= filtri.data || '' %>" class="btn btn-sm">Successivo</a><% } %>
      </div>
    </div>
    <% } %>
  <% } %>
</div>
