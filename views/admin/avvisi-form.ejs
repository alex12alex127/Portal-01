<div class="avvisi-form-page">
  <h1 class="page-title">
    <svg class="icon icon--lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
    <%= avviso ? 'Modifica avviso' : 'Nuovo avviso' %>
  </h1>
  <div class="card">
    <form id="avvisiForm" class="avvisi-form" action="<%= typeof basePath !== 'undefined' ? basePath : '' %>/admin/avvisi" method="post">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <label for="avvisi-titolo">Titolo *</label>
      <input id="avvisi-titolo" type="text" name="titolo" value="<%= avviso ? avviso.titolo : '' %>" required maxlength="255" placeholder="Es: Chiusura uffici 15 agosto">
      <label for="avvisi-contenuto">Contenuto *</label>
      <textarea id="avvisi-contenuto" name="contenuto" rows="8" required placeholder="Testo dell'avviso (puoi andare a capo)"><%= avviso ? avviso.contenuto : '' %></textarea>
      <label for="avvisi-tipo">Tipo</label>
      <select id="avvisi-tipo" name="tipo">
        <% (tipi || []).forEach(function(t) { %>
        <option value="<%= t %>"<%= (avviso && avviso.tipo === t) ? ' selected' : (!avviso && t === 'info') ? ' selected' : '' %>><%= t === 'info' ? 'Informazione' : t === 'warning' ? 'Attenzione' : t === 'urgent' ? 'Urgente' : 'Manutenzione' %></option>
        <% }); %>
      </select>
      <label class="avvisi-form__checkbox">
        <input type="checkbox" name="in_evidenza" value="1"<%= avviso && avviso.in_evidenza ? ' checked' : '' %>>
        In evidenza (mostra in cima alla lista)
      </label>
      <div class="avvisi-form__dates">
        <label for="avvisi-visibile_da">Visibile da (opzionale)</label>
        <input id="avvisi-visibile_da" type="date" name="visibile_da" value="<%= avviso && avviso.visibile_da ? avviso.visibile_da : '' %>">
        <label for="avvisi-visibile_fino">Visibile fino (opzionale)</label>
        <input id="avvisi-visibile_fino" type="date" name="visibile_fino" value="<%= avviso && avviso.visibile_fino ? avviso.visibile_fino : '' %>">
      </div>
      <div class="avvisi-form__actions">
        <a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/admin/avvisi" class="btn btn--secondary">Annulla</a>
        <button type="submit" class="btn"><%= avviso ? 'Salva modifiche' : 'Pubblica avviso' %></button>
      </div>
    </form>
    <div id="avvisiFormMsg" role="status" aria-live="polite"></div>
  </div>
</div>
<script>
(function(){
  var base = window.APP_BASE || '', form = document.getElementById('avvisiForm'), msg = document.getElementById('avvisiFormMsg');
  if (!form) return;
  var isEdit = window.location.pathname.indexOf('/modifica') !== -1;
  var idMatch = window.location.pathname.match(/\/avvisi\/(\d+)\/modifica/);
  var id = idMatch ? idMatch[1] : null;
  form.onsubmit = function(e) {
    if (isEdit && id) {
      e.preventDefault();
      msg.textContent = ''; msg.className = '';
      var payload = Object.fromEntries(new FormData(form));
      fetch(base + '/admin/avvisi/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(function(r) { return r.json(); })
        .then(function(j) {
          if (j.success) { msg.textContent = j.message || 'Avviso aggiornato.'; msg.className = 'message-ok'; }
          else { msg.textContent = j.error || 'Errore'; msg.className = 'message-error'; }
        })
        .catch(function() { msg.textContent = 'Errore di connessione'; msg.className = 'message-error'; });
    }
  };
})();
</script>
